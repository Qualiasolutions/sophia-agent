# Story 1.2: Supabase Database Setup & Agent Schema

## Status

Ready

## Story

**As a** developer,
**I want** Supabase PostgreSQL database configured with agent profiles table and connection from Next.js app,
**so that** we can store agent data and authenticate users against the database.

## Acceptance Criteria

1. Supabase project connected to Next.js app using environment variables (SUPABASE_URL, SUPABASE_ANON_KEY)
2. `agents` table created with schema: `id` (UUID), `phone_number` (text, unique), `name` (text), `email` (text), `is_active` (boolean), `created_at` (timestamp), `updated_at` (timestamp)
3. Row Level Security (RLS) policies enabled on `agents` table
4. Supabase client library installed and configured in Next.js app
5. Database connection tested via API route `/api/db-test` that queries agents table
6. Migration scripts committed to repository for reproducible schema setup
7. At least 2 test agent records inserted for development/testing

## Tasks / Subtasks

- [ ] Set up Supabase project and configure environment variables (AC: 1)
  - [ ] Create Supabase project at supabase.com (if not already created)
  - [ ] Copy `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_ANON_KEY` from Supabase dashboard → Settings → API
  - [ ] Copy `SUPABASE_SERVICE_ROLE_KEY` from Supabase dashboard → Settings → API (for admin operations)
  - [ ] Add environment variables to `.env.local` file
  - [ ] Update environment variables in Vercel dashboard → Project Settings → Environment Variables
  - [ ] Verify `.env.example` contains placeholders for these variables

- [ ] Install and configure Supabase client library (AC: 4)
  - [ ] Install Supabase JS client: `npm install @supabase/supabase-js`
  - [ ] Create Supabase client utility at `/apps/web/src/lib/supabase.ts`
  - [ ] Implement `createClient()` function using `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_ANON_KEY`
  - [ ] Implement `createAdminClient()` function using `SUPABASE_SERVICE_ROLE_KEY` for admin operations
  - [ ] Test client initialization locally

- [ ] Create agents table migration script (AC: 2, 6)
  - [ ] Create migration file: `/packages/database/supabase/migrations/001_create_agents_table.sql`
  - [ ] Define `agents` table with columns: `id` UUID PRIMARY KEY, `phone_number` TEXT UNIQUE, `name` TEXT, `email` TEXT, `is_active` BOOLEAN, `created_at` TIMESTAMPTZ, `updated_at` TIMESTAMPTZ
  - [ ] Add E.164 phone number validation constraint: `CHECK (phone_number ~ '^\+[1-9]\d{1,14}$')`
  - [ ] Add indexes on `phone_number` and `is_active` columns for query performance
  - [ ] Enable UUID extension: `CREATE EXTENSION IF NOT EXISTS "uuid-ossp"`
  - [ ] Set default values: `id` = `gen_random_uuid()`, `is_active` = `true`, `created_at`/`updated_at` = `NOW()`

- [ ] Enable Row Level Security (RLS) policies (AC: 3)
  - [ ] Enable RLS on `agents` table: `ALTER TABLE agents ENABLE ROW LEVEL SECURITY`
  - [ ] Create RLS policy: "Agents can view own data" - `FOR SELECT USING (auth.uid()::text = id::text)`
  - [ ] Create RLS policy: "Admins can view all agents" - `FOR SELECT USING (EXISTS (SELECT 1 FROM admin_users WHERE id = auth.uid()::text AND is_active = true))`
  - [ ] Create RLS policy: "Admins can insert agents" - `FOR INSERT WITH CHECK (admin role check)`
  - [ ] Create RLS policy: "Admins can update agents" - `FOR UPDATE USING (admin role check)`
  - [ ] Document RLS policies in migration script with comments

- [ ] Run migration and seed test data (AC: 6, 7)
  - [ ] Execute migration script in Supabase dashboard → SQL Editor
  - [ ] Verify table creation in Supabase dashboard → Table Editor
  - [ ] Create seed script: `/packages/database/supabase/seed.sql` with 2 test agent records
  - [ ] Execute seed script to insert test agent data
  - [ ] Verify test agents exist in Supabase Table Editor

- [ ] Implement database test endpoint (AC: 5)
  - [ ] Create API route: `/apps/web/src/app/api/db-test/route.ts`
  - [ ] Implement GET handler that queries `agents` table using Supabase client
  - [ ] Return JSON response with: `{ "status": "connected", "agentCount": <count>, "agents": [<sample agents>] }`
  - [ ] Add error handling for database connection failures
  - [ ] Test endpoint locally: `curl http://localhost:3000/api/db-test`

- [ ] Write unit tests for Supabase client (AC: 4)
  - [ ] Create test file: `/apps/web/src/lib/__tests__/supabase.test.ts`
  - [ ] Write test: Supabase client initializes with correct URL and key
  - [ ] Write test: Admin client uses service role key
  - [ ] Write test: Client throws error if environment variables are missing
  - [ ] Run tests: `npm run test`

- [ ] Write unit tests for database test endpoint (AC: 5)
  - [ ] Create test file: `/apps/web/src/app/api/db-test/__tests__/route.test.ts`
  - [ ] Write test: endpoint returns 200 status with valid database connection
  - [ ] Write test: endpoint returns correct JSON structure with agentCount and agents array
  - [ ] Write test: endpoint handles database connection errors gracefully
  - [ ] Run tests: `npm run test`

- [ ] Commit migration scripts and test deployment (AC: 6)
  - [ ] Commit all migration and seed files to repository
  - [ ] Push to GitHub and verify Vercel deployment succeeds
  - [ ] Test `/api/db-test` endpoint on Vercel deployment URL
  - [ ] Verify environment variables are correctly configured in Vercel

## Dev Notes

### Previous Story Insights

[Source: docs/stories/1.1.story.md#dev-agent-record]

- Next.js 15.5.4 installed with TypeScript 5.x, App Router, ESLint, and Tailwind CSS 4.x
- TypeScript strict mode enabled with additional compiler flags
- Path aliases configured: `@/*`, `@sophiaai/services`, `@sophiaai/shared`
- Vitest 3.x configured for unit testing
- Local dev server runs on port 3001 (port 3000 was in use)
- Vercel deployment successfully configured and connected to GitHub

### Tech Stack

[Source: architecture/3-tech-stack.md]

- **Database**: PostgreSQL 15+ (via Supabase)
- **Database Client**: Supabase JS 2.x (official Supabase SDK)
- **Authentication**: Supabase Auth 2.x (JWT-based with RLS)
- **Language**: TypeScript 5.x with strict mode enabled
- **Testing (Unit)**: Vitest 1.x for fast unit test runner

### Data Models

[Source: architecture/4-data-models.md#core-domain-models]

**Agent Interface:**
```typescript
export interface Agent {
  id: string;                      // UUID
  phoneNumber: string;              // E.164 format: +35799123456
  name: string;
  email: string;
  isActive: boolean;
  createdAt: Date;
  updatedAt: Date;
}
```

### Database Schema

[Source: architecture/9-database-schema.md#complete-sql-schema]

**Agents Table DDL:**
```sql
CREATE TABLE agents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  phone_number TEXT NOT NULL UNIQUE,
  name TEXT NOT NULL,
  email TEXT NOT NULL,
  is_active BOOLEAN NOT NULL DEFAULT true,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT phone_number_e164 CHECK (phone_number ~ '^\+[1-9]\d{1,14}$')
);

CREATE INDEX idx_agents_phone_number ON agents(phone_number);
CREATE INDEX idx_agents_is_active ON agents(is_active);
```

**Row Level Security Policies:**
```sql
ALTER TABLE agents ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Agents can view own data" ON agents
  FOR SELECT USING (auth.uid()::text = id::text);

CREATE POLICY "Admins can view all agents" ON agents
  FOR SELECT USING (
    EXISTS (SELECT 1 FROM admin_users WHERE id = auth.uid()::text AND is_active = true)
  );

CREATE POLICY "Admins can insert agents" ON agents
  FOR INSERT WITH CHECK (
    EXISTS (SELECT 1 FROM admin_users WHERE id = auth.uid()::text AND role IN ('admin', 'super_admin') AND is_active = true)
  );

CREATE POLICY "Admins can update agents" ON agents
  FOR UPDATE USING (
    EXISTS (SELECT 1 FROM admin_users WHERE id = auth.uid()::text AND role IN ('admin', 'super_admin') AND is_active = true)
  );
```

### Project Structure

[Source: architecture/12-unified-project-structure.md]

**Database Migration Files Location:**
```
packages/database/
├── supabase/
│   ├── migrations/
│   │   └── 001_create_agents_table.sql
│   └── seed.sql
├── scripts/
├── package.json
└── tsconfig.json
```

**Supabase Client Utility Location:**
```
apps/web/src/lib/supabase.ts
```

**API Route Location:**
```
apps/web/src/app/api/db-test/route.ts
```

**Environment Variables:**
[Source: architecture/12-unified-project-structure.md#environment-variables]
```bash
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://xxxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=xxxxx
SUPABASE_SERVICE_ROLE_KEY=xxxxx
```

### Coding Standards

[Source: architecture/17-coding-standards.md]

**Naming Conventions:**
- Files: kebab-case (e.g., `supabase.ts`, `db-test.test.ts`)
- Interfaces/Types: PascalCase (e.g., `Agent`)
- Functions: camelCase (e.g., `createClient()`, `createAdminClient()`)
- Constants: UPPER_SNAKE_CASE
- Database Tables: snake_case (e.g., `agents`)

**Git Commit Convention:** Conventional Commits format
```
feat(database): add Supabase client configuration
feat(database): create agents table migration
test(database): add Supabase client tests
```

### Testing

[Source: architecture/16-testing-strategy.md]

**Test Framework**: Vitest 1.x (fast, Vite-native test runner)

**Test Coverage Requirements**:
- API Routes: >70%
- Services: >80%
- Overall: >75%

**Test File Location**: Tests should be co-located with the code they test in `__tests__` directories
- Supabase client tests: `/apps/web/src/lib/__tests__/supabase.test.ts`
- Database test endpoint tests: `/apps/web/src/app/api/db-test/__tests__/route.test.ts`

**Example Unit Test Pattern**:
```typescript
describe('Supabase Client', () => {
  it('should initialize with correct configuration', () => {
    const client = createClient();
    expect(client).toBeDefined();
  });

  it('should use service role key for admin client', () => {
    const adminClient = createAdminClient();
    expect(adminClient).toBeDefined();
  });
});
```

### Technical Constraints

- **PostgreSQL Version**: 15+ required [Source: architecture/3-tech-stack.md]
- **Supabase JS Version**: 2.x [Source: architecture/3-tech-stack.md]
- **Phone Number Format**: E.164 format validation required (regex: `^\+[1-9]\d{1,14}$`) [Source: architecture/9-database-schema.md]
- **Row Level Security**: Must be enabled on all tables [Source: architecture/9-database-schema.md]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent during implementation_

### Debug Log References

_To be populated by Dev Agent during implementation_

### Completion Notes List

_To be populated by Dev Agent during implementation_

### File List

_To be populated by Dev Agent during implementation_

## QA Results

_To be populated by QA Agent after story completion_
