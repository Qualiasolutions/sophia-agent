# Story 6.1: Telegram Bot Setup & Webhook Integration

## Status

Pending

## Story

**As a** integration specialist,
**I want** Telegram Bot API configured with webhook endpoint,
**so that** users can interact with Sophia via Telegram in addition to WhatsApp.

## Acceptance Criteria

1. Telegram bot created via BotFather with unique bot token
2. Environment variables configured: `TELEGRAM_BOT_TOKEN`, `TELEGRAM_WEBHOOK_SECRET`
3. Webhook endpoint `/api/telegram-webhook` created to receive Telegram messages
4. Webhook registered with Telegram Bot API pointing to Vercel deployment URL
5. Webhook signature validation implemented for security
6. Basic message echo test working: bot receives message and responds
7. All incoming Telegram messages logged to `conversation_logs` table with source='telegram'
8. Error handling for invalid webhooks and malformed requests
9. Health check endpoint includes Telegram webhook status

## Tasks / Subtasks

- [ ] Create Telegram bot via BotFather
  - [ ] Open Telegram and start chat with @BotFather
  - [ ] Create new bot with command `/newbot`
  - [ ] Choose bot name: "Sophia Assistant" or similar
  - [ ] Choose username: `sophia_zyprus_bot` or similar (must end in 'bot')
  - [ ] Save bot token securely
  - [ ] Configure bot settings: enable inline mode, set description, set about text

- [ ] Add Telegram environment variables
  - [ ] Add `TELEGRAM_BOT_TOKEN` to `.env.local`
  - [ ] Add `TELEGRAM_WEBHOOK_SECRET` (generate random secret) to `.env.local`
  - [ ] Add same variables to Vercel production environment
  - [ ] Document variables in `.env.example`

- [ ] Create Telegram webhook types
  - [ ] Create `packages/shared/src/types/telegram.ts`
  - [ ] Define `TelegramUpdate` interface (message, callback_query, etc.)
  - [ ] Define `TelegramMessage` interface (from, chat, text, etc.)
  - [ ] Define `TelegramUser` interface (id, username, first_name, etc.)
  - [ ] Export types from `packages/shared/src/types/index.ts`

- [ ] Implement Telegram service
  - [ ] Create `packages/services/src/telegram.service.ts`
  - [ ] Implement `sendMessage(chatId: number, text: string, options?: SendMessageOptions): Promise<void>`
  - [ ] Implement `setWebhook(url: string): Promise<boolean>`
  - [ ] Implement `deleteWebhook(): Promise<boolean>`
  - [ ] Implement `getWebhookInfo(): Promise<WebhookInfo>`
  - [ ] Add retry logic with exponential backoff (similar to WhatsApp service)
  - [ ] Add rate limiting (30 messages/second per chat, 20/second overall)
  - [ ] Export TelegramService from `packages/services/src/index.ts`

- [ ] Create Telegram webhook endpoint
  - [ ] Create `/apps/web/src/app/api/telegram-webhook/route.ts`
  - [ ] Implement POST handler to receive Telegram updates
  - [ ] Validate webhook secret token (X-Telegram-Bot-Api-Secret-Token header)
  - [ ] Parse incoming Telegram message from update
  - [ ] Extract chat ID, message text, user info
  - [ ] Log message to `conversation_logs` table with source='telegram'
  - [ ] Send basic echo response for testing: "Received: {message_text}"
  - [ ] Handle errors and return appropriate HTTP status codes

- [ ] Update conversation_logs schema
  - [ ] Verify `source` column supports 'telegram' value
  - [ ] Add `telegram_chat_id` column (bigint, nullable) if needed
  - [ ] Add `telegram_message_id` column (bigint, nullable) if needed
  - [ ] Create migration if schema changes required

- [ ] Register webhook with Telegram
  - [ ] Create script or API route to set webhook URL
  - [ ] Call `setWebhook` with production Vercel URL + `/api/telegram-webhook`
  - [ ] Include `secret_token` parameter for webhook validation
  - [ ] Verify webhook registration with `getWebhookInfo`
  - [ ] Document webhook setup process in README

- [ ] Update health check endpoint
  - [ ] Modify `/apps/web/src/app/api/health/route.ts`
  - [ ] Add Telegram webhook status check
  - [ ] Include last Telegram message timestamp
  - [ ] Return webhook URL and registration status

- [ ] Write tests for Telegram integration
  - [ ] Create `packages/services/src/__tests__/telegram.service.test.ts`
  - [ ] Test sendMessage success and failure scenarios
  - [ ] Test rate limiting and retry logic
  - [ ] Create `apps/web/src/app/api/telegram-webhook/__tests__/route.test.ts`
  - [ ] Test webhook signature validation
  - [ ] Test message parsing and logging
  - [ ] Test error handling for malformed requests
  - [ ] Run all tests: `npm test`

- [ ] Test end-to-end Telegram flow
  - [ ] Deploy to Vercel with webhook configured
  - [ ] Send test message to bot from Telegram app
  - [ ] Verify message logged in `conversation_logs` table
  - [ ] Verify bot responds with echo message
  - [ ] Test with different message types (text, commands)
  - [ ] Verify error handling with invalid messages

## Dev Notes

### Architecture Considerations

[Source: PRD Epic 6.1]

- Telegram Bot API uses webhook-based integration (similar to WhatsApp)
- Webhook endpoint must be publicly accessible (Vercel serverless function)
- Telegram sends updates to webhook URL with POST requests
- Webhook secret token provides security against unauthorized requests
- All updates must be logged to maintain conversation history

### Telegram API Documentation

- Telegram Bot API: https://core.telegram.org/bots/api
- Setting webhooks: https://core.telegram.org/bots/api#setwebhook
- Update object structure: https://core.telegram.org/bots/api#update
- Message object structure: https://core.telegram.org/bots/api#message

### Rate Limiting

Telegram Bot API rate limits:
- 30 messages per second to the same chat
- 20 messages per second overall
- Implement exponential backoff on 429 responses

### Security

- Validate webhook secret token on every request
- Reject requests without valid token (403 Forbidden)
- Log all webhook validation failures for monitoring
- Use HTTPS for webhook URL (Vercel provides this automatically)

### Similar Implementation Reference

WhatsApp webhook implementation in `/apps/web/src/app/api/whatsapp-webhook/route.ts` provides good reference for:
- Webhook signature validation
- Message parsing and logging
- Error handling
- Response formatting

### Testing Strategy

- Unit tests for TelegramService methods
- Integration tests for webhook endpoint
- Manual testing with real Telegram bot
- Verify conversation_logs entries created correctly

### Environment Variables

```
TELEGRAM_BOT_TOKEN=<bot_token_from_BotFather>
TELEGRAM_WEBHOOK_SECRET=<random_generated_secret>
```

### Next Story Dependencies

Story 6.2 (Telegram User Authentication) depends on:
- Telegram webhook receiving messages successfully
- Telegram user info being extracted from messages
- conversation_logs tracking Telegram source
