# Story 6.3: Telegram Message Forwarding Functionality

## Status

Pending

## Story

**As a** backend developer,
**I want** to forward messages to contacts via Telegram,
**so that** I can quickly share information through Telegram channel.

## Acceptance Criteria

1. AI recognizes forward requests on Telegram: "forward this message to @username", "send this to telegram user john"
2. Agent provides recipient Telegram username or chat ID
3. Message forwarded to recipient via Telegram Bot API
4. Forwarding logged to new `message_forwards` table with source, destination, status, timestamp
5. Error handling for invalid recipients, blocked users, failed forwards
6. Confirmation sent to agent: "Message forwarded to @username successfully"
7. Support for forwarding different message types: text, photos, documents
8. End-to-end forwarding tested with real Telegram accounts

## Tasks / Subtasks

- [ ] Create database migration for message forwarding
  - [ ] Create `packages/database/supabase/migrations/011_create_message_forwards.sql`
  - [ ] Define `message_forwards` table schema:
    - `id` UUID PRIMARY KEY DEFAULT gen_random_uuid()
    - `agent_id` UUID NOT NULL REFERENCES agents(id)
    - `source_platform` TEXT NOT NULL (e.g., 'telegram', 'whatsapp')
    - `source_chat_id` TEXT NOT NULL
    - `destination_platform` TEXT NOT NULL
    - `destination_identifier` TEXT NOT NULL (username, chat_id, or phone number)
    - `message_content` TEXT
    - `message_type` TEXT DEFAULT 'text'
    - `forward_status` TEXT NOT NULL (e.g., 'pending', 'sent', 'failed')
    - `error_message` TEXT
    - `forwarded_at` TIMESTAMPTZ DEFAULT now()
  - [ ] Add indexes: `agent_id`, `forward_status`, `forwarded_at`
  - [ ] Add RLS policies: agents can view own forwards
  - [ ] Apply migration to Supabase database

- [ ] Create message forwarding types
  - [ ] Update `packages/shared/src/types/telegram.ts`
  - [ ] Define `MessageForward` type matching table schema
  - [ ] Define `ForwardRequest` type for API requests
  - [ ] Define `ForwardResult` type for API responses
  - [ ] Export types from `packages/shared/src/types/index.ts`

- [ ] Implement Telegram forwarding in service
  - [ ] Update `packages/services/src/telegram.service.ts`
  - [ ] Implement `forwardMessage(chatId: number, fromChatId: number, messageId: number): Promise<boolean>`
  - [ ] Implement `sendMessageToUsername(username: string, text: string): Promise<{chatId: number, success: boolean}>`
  - [ ] Implement `getChatIdByUsername(username: string): Promise<number | null>`
  - [ ] Add error handling for:
    - User not found
    - User blocked bot
    - Invalid chat ID
    - Network errors
  - [ ] Add retry logic with exponential backoff

- [ ] Create forwarding service
  - [ ] Create `packages/services/src/message-forward.service.ts`
  - [ ] Implement `createForwardLog(agentId, source, destination, content, type): Promise<MessageForward>`
  - [ ] Implement `updateForwardStatus(forwardId, status, error?): Promise<void>`
  - [ ] Implement `getForwardHistory(agentId, limit?): Promise<MessageForward[]>`
  - [ ] Implement `executeForward(forwardRequest): Promise<ForwardResult>`
  - [ ] Export MessageForwardService from `packages/services/src/index.ts`

- [ ] Add forwarding detection to AI
  - [ ] Update `packages/services/src/openai.service.ts`
  - [ ] Add function tool: `forward_telegram_message`
    - Parameters: `recipient` (string), `message` (string)
    - Description: "Forward a message to a Telegram user by username or chat ID"
  - [ ] Add system prompt guidance for recognizing forward requests
  - [ ] Update AI response type to include forwarding actions

- [ ] Implement forwarding in webhook handler
  - [ ] Update `/apps/web/src/app/api/telegram-webhook/route.ts`
  - [ ] Detect forwarding function calls from AI response
  - [ ] Parse recipient (username or chat_id)
  - [ ] Execute forward via TelegramService
  - [ ] Log forward to `message_forwards` table
  - [ ] Send confirmation or error message to agent
  - [ ] Handle edge cases:
    - Multiple recipients
    - Invalid recipients
    - Bot blocked by recipient

- [ ] Add recipient resolution logic
  - [ ] If recipient starts with '@', treat as username
  - [ ] If recipient is numeric, treat as chat_id
  - [ ] If recipient is name (e.g., "john"), search telegram_users table by first_name
  - [ ] Return clear error if recipient ambiguous or not found

- [ ] Support different message types
  - [ ] Text messages (primary)
  - [ ] Forward with original message formatting (Telegram native forward)
  - [ ] Copy message content and send as new message
  - [ ] Handle photos, documents (future enhancement, optional for MVP)

- [ ] Write tests for forwarding service
  - [ ] Create `packages/services/src/__tests__/message-forward.service.test.ts`
  - [ ] Test createForwardLog creates record successfully
  - [ ] Test updateForwardStatus updates status correctly
  - [ ] Test getForwardHistory retrieves agent's forwards
  - [ ] Test executeForward handles success and failure cases
  - [ ] Run all tests: `npm test`

- [ ] Write tests for Telegram forwarding
  - [ ] Create tests in `packages/services/src/__tests__/telegram.service.test.ts`
  - [ ] Test forwardMessage success scenario
  - [ ] Test forwardMessage with invalid chat_id
  - [ ] Test sendMessageToUsername success scenario
  - [ ] Test sendMessageToUsername with user not found
  - [ ] Test getChatIdByUsername returns correct ID
  - [ ] Run all tests: `npm test`

- [ ] Write tests for webhook forwarding flow
  - [ ] Update `apps/web/src/app/api/telegram-webhook/__tests__/route.test.ts`
  - [ ] Test AI detects forward request
  - [ ] Test forwarding to valid username succeeds
  - [ ] Test forwarding to invalid recipient returns error
  - [ ] Test forwarding confirmation message sent
  - [ ] Run all tests: `npm test`

- [ ] Test end-to-end forwarding
  - [ ] Send message to bot: "Forward this to @test_user: Hello from Sophia!"
  - [ ] Verify AI detects forward intent
  - [ ] Verify message forwarded to recipient
  - [ ] Verify confirmation sent to agent
  - [ ] Verify `message_forwards` table logged the forward
  - [ ] Test with invalid username and verify error handling
  - [ ] Test with chat_id and verify it works
  - [ ] Test with user who blocked bot and verify graceful failure

## Dev Notes

### Telegram Forwarding API

[Source: Telegram Bot API Documentation]

Telegram provides two approaches for forwarding:

**1. Native Forward (preserves original sender):**
```typescript
forwardMessage(chat_id, from_chat_id, message_id)
```

**2. Copy Message (sends as new message from bot):**
```typescript
sendMessage(chat_id, text)
```

For Sophia, **copy message approach is better** because:
- Agent wants to share content, not expose original sender
- More control over message formatting
- Simpler recipient resolution

### Recipient Resolution Strategy

Parse recipient from AI-extracted parameter:
1. If starts with '@', treat as Telegram username → call `sendMessageToUsername()`
2. If numeric, treat as chat_id → call `sendMessage()`
3. If text name, search `telegram_users` table by first_name/username → get chat_id

Example AI extractions:
- "forward to @john_doe" → username: "john_doe"
- "send to telegram user 123456789" → chat_id: 123456789
- "forward to john" → search telegram_users for name "john"

### Error Handling

Common Telegram forwarding errors:
- **User not found:** "Recipient not found. Please check the username or chat ID."
- **Bot blocked:** "Unable to forward message. The recipient has blocked the bot."
- **Invalid chat ID:** "Invalid recipient. Please provide a valid username (e.g., @username) or chat ID."
- **Network error:** "Forwarding failed. Please try again later."

### Database Schema Design

`message_forwards` table tracks all forwarding activity:
- Supports audit trail and analytics
- Enables "show my recent forwards" feature
- Helps debug forwarding failures
- Can be extended to support scheduled forwards, bulk forwards, etc.

### AI Function Tool Definition

```typescript
{
  name: 'forward_telegram_message',
  description: 'Forward a message to a Telegram user by username or chat ID',
  parameters: {
    type: 'object',
    properties: {
      recipient: {
        type: 'string',
        description: 'Telegram username (e.g., @username) or chat ID'
      },
      message: {
        type: 'string',
        description: 'Message content to forward'
      }
    },
    required: ['recipient', 'message']
  }
}
```

### System Prompt Addition

Add to OpenAI system prompt:
```
You can forward messages to Telegram users. When an agent asks to forward, send, or share a message on Telegram, use the forward_telegram_message function with the recipient and message content.

Examples:
- "Forward this to @john: Meeting at 3pm" → forward_telegram_message(recipient="@john", message="Meeting at 3pm")
- "Send this to telegram user 123456: Property viewing confirmed" → forward_telegram_message(recipient="123456", message="Property viewing confirmed")
```

### Security Considerations

- Only authenticated agents can forward messages
- No forwarding to arbitrary chat IDs (only known users or verified usernames)
- Rate limiting to prevent spam (reuse existing Telegram service rate limits)
- Log all forwards for audit purposes

### Testing Strategy

- Unit tests for recipient resolution logic
- Integration tests for Telegram API calls (mocked)
- End-to-end tests with real Telegram bot (manual)
- Test error scenarios: invalid recipient, blocked bot, network failure

### Future Enhancements (Post-MVP)

- Support forwarding photos, documents, videos
- Bulk forwarding to multiple recipients
- Scheduled forwarding
- Forward templates (pre-defined message formats)
- Forwarding analytics dashboard

### Next Story Dependencies

Story 6.4 (Basic Conversational Features) depends on:
- Telegram authentication working
- Message forwarding infrastructure in place
- AI function calling for Telegram actions
