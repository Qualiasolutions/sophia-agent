# Story 6.6: Admin Dashboard - System Overview & Monitoring

## Status

Pending

## Story

**As a** frontend developer,
**I want** system overview dashboard with real-time monitoring,
**so that** administrators can track system health and activity at a glance.

## Acceptance Criteria

1. Dashboard Overview page displays key metrics:
   - Total agents (active vs inactive)
   - Active conversations (last 24 hours)
   - Messages processed today
   - Document generations this week
   - Calculator uses this week
2. System health indicators:
   - WhatsApp webhook status (online/offline, last received)
   - Telegram webhook status (online/offline, last received)
   - Database connection status
   - OpenAI API status
3. Recent activity feed (last 20 activities across all agents)
4. Quick stats cards with visual indicators (green = healthy, red = issue)
5. Auto-refresh every 30 seconds (optional, manual refresh button required)
6. All data fetched via API routes from Supabase
7. Responsive layout for desktop and tablet
8. Loading states and error handling for all data fetches

## Tasks / Subtasks

- [ ] Create API routes for dashboard data
  - [ ] Create `/apps/web/src/app/api/admin/stats/route.ts`
  - [ ] Implement GET handler for dashboard statistics:
    - Query `agents` table for total/active count
    - Query `conversation_logs` for message counts (today, last 24h)
    - Query `document_generations` for this week's count
    - Query `calculator_history` for this week's count
    - Return JSON with all stats
  - [ ] Add authentication check (require admin session)
  - [ ] Add error handling and logging

- [ ] Create API route for system health
  - [ ] Create `/apps/web/src/app/api/admin/health/route.ts`
  - [ ] Implement GET handler for health checks:
    - Check database connection (simple query)
    - Check last WhatsApp webhook received (conversation_logs timestamp)
    - Check last Telegram webhook received (conversation_logs timestamp)
    - Check OpenAI API status (optional: test API call)
    - Return JSON with health status for each service
  - [ ] Add authentication check
  - [ ] Add timeout handling (5 seconds max)

- [ ] Create API route for recent activity
  - [ ] Create `/apps/web/src/app/api/admin/activity/route.ts`
  - [ ] Implement GET handler for recent activity:
    - Query conversation_logs, document_generations, calculator_history
    - Join with agents table for agent names
    - Combine and sort by timestamp DESC
    - Limit to 20 most recent activities
    - Return JSON array with activity items
  - [ ] Add authentication check
  - [ ] Add pagination support (optional)

- [ ] Create dashboard stats card component
  - [ ] Create `/apps/web/src/components/admin/StatsCard.tsx`
  - [ ] Props: title, value, icon, trend (up/down/neutral)
  - [ ] Display metric with large number
  - [ ] Show icon and optional trend indicator
  - [ ] Style with Tailwind CSS (card, shadow, hover effect)

- [ ] Create health indicator component
  - [ ] Create `/apps/web/src/components/admin/HealthIndicator.tsx`
  - [ ] Props: service name, status (online/offline/error), lastUpdate
  - [ ] Display green indicator for online, red for offline, yellow for error
  - [ ] Show last update timestamp (relative time, e.g., "2 minutes ago")
  - [ ] Style with Tailwind CSS

- [ ] Create activity feed component
  - [ ] Create `/apps/web/src/components/admin/ActivityFeed.tsx`
  - [ ] Props: activities (array of activity objects)
  - [ ] Display list of recent activities with timestamps
  - [ ] Group by type (message, document, calculator, etc.)
  - [ ] Use different icons for different activity types
  - [ ] Show agent name and activity description
  - [ ] Style with Tailwind CSS (scrollable list, max height 600px)

- [ ] Implement dashboard overview page
  - [ ] Update `/apps/web/src/app/admin/page.tsx`
  - [ ] Fetch dashboard stats from `/api/admin/stats`
  - [ ] Fetch health status from `/api/admin/health`
  - [ ] Fetch recent activity from `/api/admin/activity`
  - [ ] Render stats cards in grid layout (4 columns on desktop, 2 on tablet)
  - [ ] Render health indicators section
  - [ ] Render activity feed in sidebar or bottom section
  - [ ] Add loading states (skeleton loaders)
  - [ ] Add error states (error message with retry button)
  - [ ] Add manual refresh button

- [ ] Add real-time updates (optional)
  - [ ] Implement auto-refresh with setInterval (30 seconds)
  - [ ] Add toggle to enable/disable auto-refresh
  - [ ] Clear interval on component unmount
  - [ ] Show "last updated" timestamp

- [ ] Create utility functions for data formatting
  - [ ] Create `/apps/web/src/lib/format.ts`
  - [ ] Implement `formatNumber(num: number): string` (e.g., 1000 â†’ "1,000")
  - [ ] Implement `formatRelativeTime(date: Date): string` (e.g., "2 hours ago")
  - [ ] Implement `formatPercentage(value: number, total: number): string`

- [ ] Add charts/visualizations (optional, nice-to-have)
  - [ ] Install chart library: `npm install recharts`
  - [ ] Create simple bar chart for messages by day (last 7 days)
  - [ ] Create pie chart for document types distribution
  - [ ] Add to dashboard below stats cards

- [ ] Write tests for API routes
  - [ ] Create `apps/web/src/app/api/admin/stats/__tests__/route.test.ts`
  - [ ] Test stats endpoint returns correct data structure
  - [ ] Test stats endpoint requires authentication
  - [ ] Create `apps/web/src/app/api/admin/health/__tests__/route.test.ts`
  - [ ] Test health endpoint returns all service statuses
  - [ ] Test health endpoint handles database errors
  - [ ] Create `apps/web/src/app/api/admin/activity/__tests__/route.test.ts`
  - [ ] Test activity endpoint returns recent activities
  - [ ] Test activity endpoint limits to 20 items
  - [ ] Run all tests: `npm test`

- [ ] Write tests for dashboard components
  - [ ] Create `apps/web/src/components/admin/__tests__/StatsCard.test.tsx`
  - [ ] Test StatsCard renders title and value
  - [ ] Create `apps/web/src/components/admin/__tests__/HealthIndicator.test.tsx`
  - [ ] Test HealthIndicator shows correct status colors
  - [ ] Create `apps/web/src/components/admin/__tests__/ActivityFeed.test.tsx`
  - [ ] Test ActivityFeed renders activity list
  - [ ] Run all tests: `npm test`

- [ ] Test dashboard end-to-end
  - [ ] Login to admin dashboard
  - [ ] Navigate to Overview page
  - [ ] Verify stats cards display correct numbers
  - [ ] Verify health indicators show current status
  - [ ] Verify activity feed shows recent activities
  - [ ] Test refresh button updates data
  - [ ] Test on desktop (1920px) and tablet (768px) screen sizes
  - [ ] Verify loading states appear during data fetch
  - [ ] Test error handling by disconnecting database (optional)

## Dev Notes

### Dashboard Metrics

[Source: PRD Epic 6.6]

**Key Metrics to Display:**
1. **Total Agents** - Count from `agents` table where is_active=true
2. **Active Conversations** - Count distinct agent_id from `conversation_logs` last 24h
3. **Messages Today** - Count from `conversation_logs` where created_at >= today
4. **Documents This Week** - Count from `document_generations` where created_at >= 7 days ago
5. **Calculators This Week** - Count from `calculator_history` where created_at >= 7 days ago

**SQL Queries:**
```sql
-- Total agents
SELECT COUNT(*) FROM agents WHERE is_active = true;

-- Active conversations (last 24h)
SELECT COUNT(DISTINCT agent_id) FROM conversation_logs
WHERE created_at >= NOW() - INTERVAL '24 hours';

-- Messages today
SELECT COUNT(*) FROM conversation_logs
WHERE created_at >= CURRENT_DATE;

-- Documents this week
SELECT COUNT(*) FROM document_generations
WHERE created_at >= CURRENT_DATE - INTERVAL '7 days';

-- Calculators this week
SELECT COUNT(*) FROM calculator_history
WHERE created_at >= CURRENT_DATE - INTERVAL '7 days';
```

### Health Check Logic

**Service Health Indicators:**
1. **WhatsApp Webhook** - Online if message received in last 5 minutes
2. **Telegram Webhook** - Online if message received in last 5 minutes
3. **Database** - Online if connection successful and query executes
4. **OpenAI API** - Online if last AI response succeeded (check conversation_logs metadata)

**Status Colors:**
- ðŸŸ¢ Online/Healthy (last activity < 5 minutes)
- ðŸŸ¡ Warning (last activity 5-30 minutes)
- ðŸ”´ Offline/Error (last activity > 30 minutes or error)

### Recent Activity Feed

**Activity Types:**
- Message sent (conversation_logs)
- Document generated (document_generations)
- Calculator used (calculator_history)
- Agent registered (agents)
- Email sent (email_logs, if Epic 5 complete)

**Activity Format:**
```typescript
{
  id: string;
  type: 'message' | 'document' | 'calculator' | 'email';
  agentName: string;
  description: string;
  timestamp: Date;
  icon: ReactNode;
}
```

**Example descriptions:**
- "John Doe sent a WhatsApp message"
- "Maria Costa generated Reg_Banks document"
- "Alex Petrou calculated transfer fees for â‚¬300,000"

### Component Library Options

**Option 1: Tailwind CSS only (lightest)**
- Use Tailwind utility classes for all styling
- No additional dependencies
- Full control over design

**Option 2: shadcn/ui (recommended)**
- Pre-built, accessible components
- Tailwind CSS based
- Easy to customize
- Install with: `npx shadcn-ui@latest init`

**Option 3: Material-UI or Ant Design**
- Full-featured component libraries
- Heavier bundle size
- More opinionated design

**Recommendation:** Use shadcn/ui for consistent, accessible components with minimal overhead.

### Auto-Refresh Implementation

```typescript
useEffect(() => {
  const interval = setInterval(() => {
    if (autoRefreshEnabled) {
      refreshData();
    }
  }, 30000); // 30 seconds

  return () => clearInterval(interval);
}, [autoRefreshEnabled]);
```

### Loading States

Use skeleton loaders for better UX:
```typescript
{isLoading ? (
  <div className="animate-pulse">
    <div className="h-24 bg-gray-200 rounded"></div>
  </div>
) : (
  <StatsCard title="Total Agents" value={stats.totalAgents} />
)}
```

### Error Handling

Display user-friendly error messages:
```typescript
{error ? (
  <div className="bg-red-50 border border-red-200 rounded p-4">
    <p className="text-red-800">Failed to load dashboard data.</p>
    <button onClick={retry} className="text-red-600 underline">
      Retry
    </button>
  </div>
) : (
  // Render data
)}
```

### Responsive Layout

**Desktop (1920px):**
- 4-column grid for stats cards
- Full-width activity feed at bottom
- Side-by-side health indicators

**Tablet (768px):**
- 2-column grid for stats cards
- Stacked health indicators
- Full-width activity feed

**Tailwind classes:**
```tsx
<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
  {/* Stats cards */}
</div>
```

### Performance Considerations

- Cache dashboard stats on server (1-minute TTL)
- Use React Query for client-side caching (optional)
- Lazy load activity feed (render only visible items)
- Optimize database queries with indexes

### Testing Strategy

- Unit tests for API routes (mocked database)
- Unit tests for components (mocked data)
- Integration tests for data fetching
- Manual testing for responsiveness
- Performance testing for large datasets

### Future Enhancements (Post-MVP)

- Real-time WebSocket updates (instead of polling)
- Customizable dashboard widgets (drag-and-drop)
- Downloadable reports (PDF, CSV)
- Alerting system for critical issues
- Historical trend charts (last 30 days)

### Next Story Dependencies

Story 6.7 (Agent Management) depends on:
- Admin dashboard layout in place
- API route authentication working
- Component patterns established (cards, tables)
