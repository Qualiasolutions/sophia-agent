# Story 6.4: Basic Telegram Conversational Features

## Status

Pending

## Story

**As an** AI-LLM specialist,
**I want** basic conversational features on Telegram similar to WhatsApp,
**so that** I can use Sophia's core features from Telegram.

## Acceptance Criteria

1. Telegram users can access document generation: "sophia generate marketing form v2"
2. Telegram users can access calculators: "calculate mortgage for 300k"
3. Telegram users can send emails: "send email to client@example.com" (if Epic 5 completed)
4. AI responses formatted for Telegram (supports Telegram markdown formatting)
5. Conversation history maintained across messages (same as WhatsApp)
6. All features tested end-to-end on Telegram
7. Error responses formatted appropriately for Telegram
8. Response time <5 seconds for complex requests (same as WhatsApp)

## Tasks / Subtasks

- [ ] Integrate OpenAI service with Telegram webhook
  - [ ] Update `/apps/web/src/app/api/telegram-webhook/route.ts`
  - [ ] After authentication, pass message to OpenAI service
  - [ ] Retrieve conversation history from `conversation_logs` (last 10 messages, source='telegram')
  - [ ] Build conversation context similar to WhatsApp handler
  - [ ] Call OpenAI service with context + user message
  - [ ] Handle AI response and function calls

- [ ] Add Telegram-specific formatting
  - [ ] Create utility function for Telegram markdown formatting
  - [ ] Convert AI responses to Telegram MarkdownV2 format
  - [ ] Escape special characters: `_`, `*`, `[`, `]`, `(`, `)`, `~`, `` ` ``, `>`, `#`, `+`, `-`, `=`, `|`, `{`, `}`, `.`, `!`
  - [ ] Format bold: `*text*`
  - [ ] Format italic: `_text_`
  - [ ] Format code: `` `code` ``
  - [ ] Format code blocks: ``` ```language\ncode\n``` ```

- [ ] Enable document generation via Telegram
  - [ ] Verify OpenAI Assistant integration works with Telegram
  - [ ] Test document request: "generate reg_banks for John Doe"
  - [ ] Verify Assistant response sent back to Telegram
  - [ ] Verify document generation logged to `document_generations` table
  - [ ] Test multiple document types

- [ ] Enable calculators via Telegram
  - [ ] Verify calculator function calling works with Telegram
  - [ ] Test transfer fees: "calculate transfer fees for 300k"
  - [ ] Test capital gains: "calculate capital gains for property bought at 250k, selling at 400k"
  - [ ] Test VAT calculator: "calculate vat for 350k apartment"
  - [ ] Verify results logged to `calculator_history` table
  - [ ] Test "list calculators" and "show calculator history" commands

- [ ] Enable email sending via Telegram (if Epic 5 complete)
  - [ ] Verify email function calling works with Telegram
  - [ ] Test send email: "send email to test@example.com subject Testing body Hello"
  - [ ] Verify email logged appropriately
  - [ ] Handle email feature gracefully if Epic 5 not yet implemented

- [ ] Implement conversation history for Telegram
  - [ ] Retrieve last 10 messages from `conversation_logs` for chat_id
  - [ ] Build conversation context array for OpenAI
  - [ ] Include both agent messages and Sophia responses
  - [ ] Filter by source='telegram' and agent_id
  - [ ] Sort by created_at DESC, limit 10
  - [ ] Reverse array to get chronological order

- [ ] Handle function calls in Telegram webhook
  - [ ] Detect function calls in AI response (calculator, document, forward, email)
  - [ ] Execute calculator functions and return formatted results
  - [ ] Execute document requests via Assistant service
  - [ ] Execute forwarding via TelegramService
  - [ ] Execute email sending (if Epic 5 complete)
  - [ ] Log all function calls appropriately

- [ ] Add error handling for Telegram
  - [ ] Catch OpenAI timeout errors (>5 seconds)
  - [ ] Catch database errors
  - [ ] Catch Telegram API errors
  - [ ] Send user-friendly error messages
  - [ ] Log errors for monitoring

- [ ] Write tests for conversational features
  - [ ] Update `apps/web/src/app/api/telegram-webhook/__tests__/route.test.ts`
  - [ ] Test document generation request flow
  - [ ] Test calculator request flow
  - [ ] Test conversation history retrieval
  - [ ] Test Telegram markdown formatting
  - [ ] Test error handling scenarios
  - [ ] Run all tests: `npm test`

- [ ] Test end-to-end Telegram conversational flow
  - [ ] Send document request and verify response
  - [ ] Send calculator request and verify result
  - [ ] Send multi-turn conversation and verify history maintained
  - [ ] Test error scenarios (invalid input, timeout)
  - [ ] Verify all features work equivalently to WhatsApp
  - [ ] Test concurrent conversations from multiple Telegram users

## Dev Notes

### Telegram Markdown Formatting

[Source: Telegram Bot API - MarkdownV2]

Telegram uses MarkdownV2 format with strict escaping requirements:
- Special characters must be escaped with `\`: `_*[]()~` >`#+-=|{}.!`
- Code spans: `` `code` ``
- Bold: `*bold*`
- Italic: `_italic_`
- Links: `[text](url)`

**Example utility function:**
```typescript
function formatForTelegram(text: string): string {
  // Escape special MarkdownV2 characters
  return text.replace(/([_*\[\]()~`>#+\-=|{}.!])/g, '\\$1');
}
```

### Conversation History Query

```sql
SELECT * FROM conversation_logs
WHERE agent_id = $1 AND source = 'telegram'
ORDER BY created_at DESC
LIMIT 10;
```

Then reverse array to get chronological order for OpenAI context.

### Feature Parity with WhatsApp

Telegram should support all core features:
- ✅ Document generation (via OpenAI Assistant)
- ✅ Calculators (transfer fees, capital gains, VAT)
- ✅ Message forwarding (Telegram-specific)
- ⏳ Email sending (if Epic 5 complete)
- ⏳ Property listing (if Epic 4 complete, likely skipped)

### OpenAI Service Integration

Reuse existing OpenAI service (`packages/services/src/openai.service.ts`):
- Same `generateAIResponse()` function
- Same conversation context structure
- Same function calling tools (calculator, document, email)
- Add Telegram-specific tools (forwarding)

### Webhook Handler Structure

```typescript
// Simplified flow
export async function POST(request: Request) {
  // 1. Validate webhook secret
  // 2. Parse Telegram update
  // 3. Authenticate user (check telegram_users table)
  // 4. If not registered, handle registration flow
  // 5. Retrieve conversation history
  // 6. Call OpenAI service
  // 7. Handle function calls (calculator, document, forward, email)
  // 8. Send response via Telegram API
  // 9. Log conversation to conversation_logs
}
```

### Error Messages for Telegram

User-friendly error messages:
- OpenAI timeout: "Sorry, I'm taking longer than usual. Please try again."
- Database error: "I'm having trouble accessing my memory. Please try again in a moment."
- Invalid request: "I didn't understand that request. Could you rephrase?"
- Feature not available: "That feature isn't available on Telegram yet. Please use WhatsApp."

### Response Time Requirements

[Source: PRD NFR1]
- Simple queries: <2 seconds
- Complex operations (document generation, calculator): <5 seconds
- Implement timeout handling for OpenAI calls (5-second timeout)

### Testing Strategy

- Unit tests for Telegram markdown formatting
- Integration tests for conversation flow
- Manual testing with real Telegram bot
- Load testing for concurrent conversations (optional)

### Code Reuse from WhatsApp

Reference WhatsApp webhook handler:
`/apps/web/src/app/api/whatsapp-webhook/route.ts`

Key sections to reuse:
- Conversation history retrieval
- OpenAI service integration
- Function call handling
- Error handling patterns
- Logging structure

### Next Story Dependencies

Story 6.5 (Admin Dashboard Authentication) is independent and can proceed in parallel.
Admin dashboard will provide visibility into Telegram conversations, user registrations, and forwarding activity.

### Future Enhancements (Post-MVP)

- Rich media support (photos, videos, documents)
- Inline buttons for quick actions
- Telegram-specific commands (/start, /help, /status)
- Group chat support
- Channel broadcasting
