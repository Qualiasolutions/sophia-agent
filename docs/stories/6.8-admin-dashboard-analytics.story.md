# Story 6.8: Admin Dashboard - Analytics & Reporting

## Status

Complete

## Story

**As a** frontend developer,
**I want** analytics and reporting dashboard with charts and metrics,
**so that** administrators can track usage patterns, performance, and trends over time.

## Acceptance Criteria

1. Analytics page displays key metrics with time-based charts:
   - Messages per day (last 30 days)
   - Documents generated per week (last 12 weeks)
   - Calculator uses per day (last 30 days)
   - Active agents trend (last 30 days)
2. Breakdown charts:
   - Document types distribution (pie chart)
   - Calculator types distribution (pie chart)
   - Messages by source (WhatsApp vs Telegram)
3. Performance metrics:
   - Average response time
   - Peak usage hours
   - Most active agents (top 10)
4. Date range selector (last 7 days, 30 days, 90 days, custom range)
5. Export functionality (download charts as PNG or data as CSV)
6. All charts interactive with hover tooltips
7. Responsive layout for desktop and tablet
8. Loading states and error handling for all data fetches

## Tasks / Subtasks

- [ ] Install charting library
  - [ ] Install Recharts: `npm install recharts`
  - [ ] Or install Chart.js: `npm install react-chartjs-2 chart.js`
  - [ ] Choose based on preference (Recharts recommended for React)

- [ ] Create API route for analytics data
  - [ ] Create `/apps/web/src/app/api/admin/analytics/route.ts`
  - [ ] Implement GET handler with query params: startDate, endDate
  - [ ] Query messages per day:
    - Group conversation_logs by DATE(created_at)
    - Count messages per day
    - Return array of {date, count}
  - [ ] Query documents per week:
    - Group document_generations by week
    - Count documents per week
    - Return array of {week, count}
  - [ ] Query calculator uses per day:
    - Group calculator_history by DATE(created_at)
    - Count uses per day
    - Return array of {date, count}
  - [ ] Query active agents trend:
    - Count distinct agent_id per day from conversation_logs
    - Return array of {date, count}
  - [ ] Add authentication check
  - [ ] Add caching (5-minute TTL)

- [ ] Create API route for breakdown data
  - [ ] Create `/apps/web/src/app/api/admin/analytics/breakdown/route.ts`
  - [ ] Implement GET handler
  - [ ] Query document types distribution:
    - Group document_generations by template_filename
    - Count documents per type
    - Return array of {type, count}
  - [ ] Query calculator types distribution:
    - Group calculator_history by calculator_id
    - Join with calculators table for name
    - Return array of {type, count}
  - [ ] Query messages by source:
    - Group conversation_logs by source (whatsapp, telegram)
    - Count messages per source
    - Return array of {source, count}
  - [ ] Add authentication check

- [ ] Create API route for performance metrics
  - [ ] Create `/apps/web/src/app/api/admin/analytics/performance/route.ts`
  - [ ] Implement GET handler
  - [ ] Calculate average response time:
    - Query conversation_logs for AI response times (if tracked)
    - Calculate average across date range
  - [ ] Identify peak usage hours:
    - Group conversation_logs by HOUR(created_at)
    - Count messages per hour
    - Return top 3 hours
  - [ ] Get most active agents:
    - Count messages per agent from conversation_logs
    - Join with agents table for names
    - Return top 10 agents
  - [ ] Add authentication check

- [ ] Create line chart component for time series
  - [ ] Create `/apps/web/src/components/admin/LineChart.tsx`
  - [ ] Props: data (array of {date, value}), title, color
  - [ ] Use Recharts LineChart component
  - [ ] Configure axes, tooltips, grid
  - [ ] Style with Tailwind CSS
  - [ ] Make responsive (adjust based on container width)

- [ ] Create pie chart component for distributions
  - [ ] Create `/apps/web/src/components/admin/PieChart.tsx`
  - [ ] Props: data (array of {name, value}), title, colors
  - [ ] Use Recharts PieChart component
  - [ ] Add legend and tooltips
  - [ ] Style with Tailwind CSS
  - [ ] Make responsive

- [ ] Create bar chart component for rankings
  - [ ] Create `/apps/web/src/components/admin/BarChart.tsx`
  - [ ] Props: data (array of {label, value}), title, color
  - [ ] Use Recharts BarChart component
  - [ ] Configure axes, tooltips
  - [ ] Style with Tailwind CSS
  - [ ] Make responsive

- [ ] Create date range selector component
  - [ ] Create `/apps/web/src/components/admin/DateRangeSelector.tsx`
  - [ ] Presets: Last 7 days, Last 30 days, Last 90 days
  - [ ] Custom range: start date and end date inputs
  - [ ] Props: value, onChange
  - [ ] Style with Tailwind CSS
  - [ ] Validate date range (end >= start)

- [ ] Implement analytics page
  - [ ] Create `/apps/web/src/app/admin/analytics/page.tsx`
  - [ ] Add date range selector
  - [ ] Fetch analytics data from API routes based on date range
  - [ ] Render time series charts:
    - Messages per day (line chart)
    - Documents per week (line chart)
    - Calculator uses per day (line chart)
    - Active agents trend (line chart)
  - [ ] Render breakdown charts:
    - Document types (pie chart)
    - Calculator types (pie chart)
    - Messages by source (pie chart)
  - [ ] Render performance metrics:
    - Average response time (stat card)
    - Peak usage hours (stat card)
    - Most active agents (bar chart or list)
  - [ ] Add loading states (skeleton loaders)
  - [ ] Add error handling
  - [ ] Layout in grid (2 columns on desktop, 1 on tablet)

- [ ] Add export functionality
  - [ ] Create export button for each chart
  - [ ] Implement PNG export (use html2canvas library)
  - [ ] Implement CSV export (convert data to CSV format)
  - [ ] Trigger browser download on export
  - [ ] Add "Export All" button to download all data

- [ ] Create utility functions for data processing
  - [ ] Create `/apps/web/src/lib/analytics.ts`
  - [ ] Implement `aggregateByDay(data, dateField): Array<{date, count}>`
  - [ ] Implement `aggregateByWeek(data, dateField): Array<{week, count}>`
  - [ ] Implement `calculatePercentage(part, total): number`
  - [ ] Implement `formatChartDate(date): string` (e.g., "Jan 15")

- [ ] Add chart interactivity
  - [ ] Enable tooltips on hover (Recharts provides this)
  - [ ] Add zoom functionality for time series charts (optional)
  - [ ] Add click handlers to drill down (optional, future enhancement)
  - [ ] Highlight selected date range on charts

- [ ] Write tests for API routes
  - [ ] Create `apps/web/src/app/api/admin/analytics/__tests__/route.test.ts`
  - [ ] Test analytics endpoint returns correct data structure
  - [ ] Test analytics endpoint filters by date range
  - [ ] Test analytics endpoint requires authentication
  - [ ] Create `apps/web/src/app/api/admin/analytics/breakdown/__tests__/route.test.ts`
  - [ ] Test breakdown endpoint returns distributions
  - [ ] Create `apps/web/src/app/api/admin/analytics/performance/__tests__/route.test.ts`
  - [ ] Test performance endpoint returns metrics
  - [ ] Run all tests: `npm test`

- [ ] Write tests for chart components
  - [ ] Create `apps/web/src/components/admin/__tests__/LineChart.test.tsx`
  - [ ] Test LineChart renders with data
  - [ ] Create `apps/web/src/components/admin/__tests__/PieChart.test.tsx`
  - [ ] Test PieChart renders with data
  - [ ] Create `apps/web/src/components/admin/__tests__/BarChart.test.tsx`
  - [ ] Test BarChart renders with data
  - [ ] Run all tests: `npm test`

- [ ] Test analytics dashboard end-to-end
  - [ ] Login to admin dashboard
  - [ ] Navigate to Analytics page
  - [ ] Verify all charts render correctly
  - [ ] Change date range and verify charts update
  - [ ] Hover over chart elements and verify tooltips
  - [ ] Click export button and verify download works
  - [ ] Test on desktop (1920px) and tablet (768px)
  - [ ] Verify loading states appear during data fetch
  - [ ] Test with empty data (no activity in date range)

## Dev Notes

### Analytics Metrics

[Source: PRD Epic 6.8]

**Time Series Metrics:**
1. **Messages per day** - Daily message volume trend
2. **Documents per week** - Weekly document generation trend
3. **Calculator uses per day** - Daily calculator usage trend
4. **Active agents trend** - Daily unique agent activity

**Distribution Metrics:**
1. **Document types** - Which templates are most used
2. **Calculator types** - Which calculators are most popular
3. **Messages by source** - WhatsApp vs Telegram usage

**Performance Metrics:**
1. **Average response time** - Mean AI response latency
2. **Peak usage hours** - When is Sophia most active
3. **Most active agents** - Top 10 power users

### Database Queries for Time Series

**Messages per day (last 30 days):**
```sql
SELECT DATE(created_at) as date, COUNT(*) as count
FROM conversation_logs
WHERE created_at >= CURRENT_DATE - INTERVAL '30 days'
GROUP BY DATE(created_at)
ORDER BY date;
```

**Documents per week (last 12 weeks):**
```sql
SELECT DATE_TRUNC('week', created_at) as week, COUNT(*) as count
FROM document_generations
WHERE created_at >= CURRENT_DATE - INTERVAL '12 weeks'
GROUP BY DATE_TRUNC('week', created_at)
ORDER BY week;
```

**Active agents per day:**
```sql
SELECT DATE(created_at) as date, COUNT(DISTINCT agent_id) as count
FROM conversation_logs
WHERE created_at >= CURRENT_DATE - INTERVAL '30 days'
GROUP BY DATE(created_at)
ORDER BY date;
```

### Database Queries for Distributions

**Document types distribution:**
```sql
SELECT template_filename as type, COUNT(*) as count
FROM document_generations
WHERE created_at >= $startDate AND created_at <= $endDate
GROUP BY template_filename
ORDER BY count DESC;
```

**Calculator types distribution:**
```sql
SELECT c.name as type, COUNT(*) as count
FROM calculator_history ch
JOIN calculators c ON ch.calculator_id = c.id
WHERE ch.created_at >= $startDate AND ch.created_at <= $endDate
GROUP BY c.name
ORDER BY count DESC;
```

**Messages by source:**
```sql
SELECT source, COUNT(*) as count
FROM conversation_logs
WHERE created_at >= $startDate AND created_at <= $endDate
GROUP BY source
ORDER BY count DESC;
```

### Recharts Configuration

[Source: Recharts Documentation]

**Line Chart Example:**
```tsx
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';

<ResponsiveContainer width="100%" height={300}>
  <LineChart data={data}>
    <CartesianGrid strokeDasharray="3 3" />
    <XAxis dataKey="date" />
    <YAxis />
    <Tooltip />
    <Legend />
    <Line type="monotone" dataKey="count" stroke="#0066CC" />
  </LineChart>
</ResponsiveContainer>
```

**Pie Chart Example:**
```tsx
import { PieChart, Pie, Cell, Tooltip, Legend, ResponsiveContainer } from 'recharts';

const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884D8'];

<ResponsiveContainer width="100%" height={300}>
  <PieChart>
    <Pie
      data={data}
      dataKey="value"
      nameKey="name"
      cx="50%"
      cy="50%"
      outerRadius={80}
      fill="#8884d8"
      label
    >
      {data.map((entry, index) => (
        <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
      ))}
    </Pie>
    <Tooltip />
    <Legend />
  </PieChart>
</ResponsiveContainer>
```

### Date Range Selector

**Preset Ranges:**
```typescript
const presets = [
  { label: 'Last 7 days', value: 7 },
  { label: 'Last 30 days', value: 30 },
  { label: 'Last 90 days', value: 90 }
];

const handlePresetClick = (days: number) => {
  const endDate = new Date();
  const startDate = new Date();
  startDate.setDate(startDate.getDate() - days);
  onChange({ startDate, endDate });
};
```

### Export Functionality

**PNG Export (chart as image):**
```typescript
import html2canvas from 'html2canvas';

const exportChartAsPNG = async (elementId: string) => {
  const element = document.getElementById(elementId);
  const canvas = await html2canvas(element);
  const dataURL = canvas.toDataURL('image/png');
  const link = document.createElement('a');
  link.download = `${elementId}-chart.png`;
  link.href = dataURL;
  link.click();
};
```

**CSV Export (data as spreadsheet):**
```typescript
const exportDataAsCSV = (data: any[], filename: string) => {
  const headers = Object.keys(data[0]).join(',');
  const rows = data.map(row => Object.values(row).join(','));
  const csv = [headers, ...rows].join('\n');

  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.download = filename;
  link.href = url;
  link.click();
};
```

### Response Time Tracking

Response time can be calculated if conversation_logs stores metadata:
```typescript
// In conversation_logs, add metadata field (jsonb)
{
  "ai_response_time_ms": 2340,
  "openai_duration_ms": 1850,
  "total_duration_ms": 2340
}

// Query average response time
SELECT AVG((metadata->>'ai_response_time_ms')::int) as avg_response_time
FROM conversation_logs
WHERE metadata ? 'ai_response_time_ms'
AND created_at >= $startDate AND created_at <= $endDate;
```

If not tracked yet, can add in future enhancement.

### Peak Usage Hours

```sql
SELECT EXTRACT(HOUR FROM created_at) as hour, COUNT(*) as count
FROM conversation_logs
WHERE created_at >= $startDate AND created_at <= $endDate
GROUP BY EXTRACT(HOUR FROM created_at)
ORDER BY count DESC
LIMIT 3;
```

Returns top 3 hours (e.g., 9am, 2pm, 5pm).

### Most Active Agents

```sql
SELECT a.name, a.email, COUNT(cl.id) as message_count
FROM conversation_logs cl
JOIN agents a ON cl.agent_id = a.id
WHERE cl.created_at >= $startDate AND cl.created_at <= $endDate
GROUP BY a.id, a.name, a.email
ORDER BY message_count DESC
LIMIT 10;
```

### Responsive Chart Layout

**Desktop (1920px):**
- 2-column grid for charts
- Larger chart heights (400px)
- Side-by-side comparisons

**Tablet (768px):**
- 1-column stack
- Smaller chart heights (300px)
- Vertical scrolling

**Tailwind classes:**
```tsx
<div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <div className="bg-white p-6 rounded-lg shadow">
    <LineChart data={messagesData} />
  </div>
  {/* More charts */}
</div>
```

### Caching Strategy

Analytics data doesn't need real-time accuracy:
- Cache API responses for 5 minutes (TTL=300s)
- Use Vercel Edge Config or Redis for caching
- Invalidate cache when date range changes
- Show "Last updated: X minutes ago" timestamp

### Performance Optimization

- Lazy load charts (render only visible charts)
- Debounce date range changes (wait 500ms before fetching)
- Paginate large datasets (> 100 data points)
- Use Chart.js for simpler, faster rendering (alternative to Recharts)

### Testing Strategy

- Unit tests for data aggregation functions
- Integration tests for analytics API routes
- Visual regression tests for charts (optional, with Percy or Chromatic)
- Manual testing for interactivity
- Performance testing with large datasets

### Future Enhancements (Post-MVP)

- Real-time analytics with WebSocket updates
- Predictive analytics (forecast trends)
- Custom report builder (select metrics, date range, export)
- Scheduled email reports (daily/weekly summaries)
- Drill-down functionality (click chart to see details)
- Comparison view (compare two date ranges)
- Agent-specific analytics (per-agent dashboard)

### Next Story Dependencies

Story 6.9 (Configuration & Template Management) depends on:
- Admin dashboard patterns established
- CRUD operation patterns from agent management
- Form components from previous stories
