# Story 6.5: Admin Dashboard - Authentication & Layout

## Status

Pending

## Story

**As a** frontend developer,
**I want** secure admin dashboard with authentication,
**so that** only authorized users can access system monitoring and configuration.

## Acceptance Criteria

1. Admin dashboard accessible at `/admin` route
2. NextAuth.js configured with email/password authentication
3. Admin users table created with bcrypt-hashed passwords
4. Login page with email and password fields
5. Session management with secure cookies
6. Unauthenticated users redirected to login page
7. Dashboard layout with navigation: Overview, Agents, Analytics, Templates, Calculators, Logs, Settings
8. Responsive design works on desktop and tablet
9. End-to-end authentication flow tested

## Tasks / Subtasks

- [ ] Install dependencies
  - [ ] Install NextAuth.js: `npm install next-auth @next-auth/supabase-adapter bcryptjs`
  - [ ] Install types: `npm install -D @types/bcryptjs`
  - [ ] Install UI components: `npm install @radix-ui/react-dropdown-menu @radix-ui/react-dialog`

- [ ] Create database migration for admin users
  - [ ] Create `packages/database/supabase/migrations/012_create_admin_users.sql`
  - [ ] Define `admin_users` table schema:
    - `id` UUID PRIMARY KEY DEFAULT gen_random_uuid()
    - `email` TEXT UNIQUE NOT NULL
    - `password_hash` TEXT NOT NULL
    - `full_name` TEXT NOT NULL
    - `role` TEXT DEFAULT 'admin' (e.g., 'super_admin', 'admin', 'viewer')
    - `is_active` BOOLEAN DEFAULT true
    - `last_login_at` TIMESTAMPTZ
    - `created_at` TIMESTAMPTZ DEFAULT now()
  - [ ] Add indexes: `email`, `is_active`
  - [ ] Add RLS policies: admin_users can view own data, super_admin can view all
  - [ ] Seed initial admin user with hashed password
  - [ ] Apply migration to Supabase database

- [ ] Configure NextAuth.js
  - [ ] Create `/apps/web/src/app/api/auth/[...nextauth]/route.ts`
  - [ ] Configure CredentialsProvider for email/password
  - [ ] Implement authorize function:
    - Query admin_users by email
    - Verify password with bcrypt
    - Return user object if valid
  - [ ] Configure session strategy: 'jwt'
  - [ ] Add NEXTAUTH_SECRET environment variable
  - [ ] Add NEXTAUTH_URL environment variable
  - [ ] Configure callbacks (jwt, session)

- [ ] Create authentication utilities
  - [ ] Create `/apps/web/src/lib/auth.ts`
  - [ ] Implement `hashPassword(password: string): Promise<string>`
  - [ ] Implement `verifyPassword(password: string, hash: string): Promise<boolean>`
  - [ ] Implement `getServerSession(): Promise<Session | null>`
  - [ ] Implement `requireAuth(): Promise<Session>` (throws if not authenticated)

- [ ] Create login page
  - [ ] Create `/apps/web/src/app/admin/login/page.tsx`
  - [ ] Build login form with email and password fields
  - [ ] Add form validation (required fields, email format)
  - [ ] Implement login handler using NextAuth signIn()
  - [ ] Show error messages for invalid credentials
  - [ ] Redirect to /admin after successful login
  - [ ] Add "Remember me" option (optional)

- [ ] Create admin layout component
  - [ ] Create `/apps/web/src/app/admin/layout.tsx`
  - [ ] Check authentication with getServerSession()
  - [ ] Redirect to /admin/login if not authenticated
  - [ ] Build navigation sidebar with links:
    - Overview (/)
    - Agents (/admin/agents)
    - Analytics (/admin/analytics)
    - Templates (/admin/templates)
    - Calculators (/admin/calculators)
    - Logs (/admin/logs)
    - Settings (/admin/settings)
  - [ ] Add header with user info and logout button
  - [ ] Implement responsive design (collapsible sidebar on mobile)

- [ ] Create admin dashboard home page
  - [ ] Create `/apps/web/src/app/admin/page.tsx`
  - [ ] Display welcome message with user's name
  - [ ] Add placeholder content (will be populated in Story 6.6)
  - [ ] Verify authentication working

- [ ] Create logout functionality
  - [ ] Add logout button in header
  - [ ] Implement logout handler using NextAuth signOut()
  - [ ] Redirect to /admin/login after logout
  - [ ] Clear session cookies

- [ ] Add session middleware
  - [ ] Create `/apps/web/src/middleware.ts` (if not exists)
  - [ ] Protect /admin routes (except /admin/login)
  - [ ] Redirect unauthenticated requests to /admin/login
  - [ ] Allow authenticated requests to proceed

- [ ] Style admin dashboard
  - [ ] Use Tailwind CSS for styling
  - [ ] Create consistent color scheme (professional, clean)
  - [ ] Add Sophia branding (logo, colors from PRD)
  - [ ] Ensure responsive design on desktop (1920px) and tablet (768px)
  - [ ] Add hover states, active states for navigation
  - [ ] Use shadcn/ui components for consistency (optional)

- [ ] Write tests for authentication
  - [ ] Create `apps/web/src/app/api/auth/__tests__/auth.test.ts`
  - [ ] Test hashPassword generates valid bcrypt hash
  - [ ] Test verifyPassword validates correctly
  - [ ] Test verifyPassword rejects incorrect password
  - [ ] Create `apps/web/src/app/admin/__tests__/layout.test.ts`
  - [ ] Test unauthenticated user redirected to login
  - [ ] Test authenticated user can access admin pages
  - [ ] Run all tests: `npm test`

- [ ] Test end-to-end authentication
  - [ ] Navigate to /admin (should redirect to /admin/login)
  - [ ] Enter invalid credentials, verify error shown
  - [ ] Enter valid credentials, verify redirect to /admin
  - [ ] Verify session persists across page reloads
  - [ ] Click logout, verify redirect to /admin/login
  - [ ] Verify navigation works between admin pages
  - [ ] Test on desktop and tablet screen sizes

## Dev Notes

### NextAuth.js Configuration

[Source: NextAuth.js Documentation]

NextAuth.js provides authentication for Next.js applications:
- Built-in support for credentials-based login
- Session management with JWT
- Secure cookie handling
- Server-side session verification

**Configuration file structure:**
```typescript
// /apps/web/src/app/api/auth/[...nextauth]/route.ts
import NextAuth from 'next-auth';
import CredentialsProvider from 'next-auth/providers/credentials';

const handler = NextAuth({
  providers: [
    CredentialsProvider({
      name: 'Credentials',
      credentials: {
        email: { label: "Email", type: "email" },
        password: { label: "Password", type: "password" }
      },
      async authorize(credentials) {
        // Validate credentials against database
        // Return user object or null
      }
    })
  ],
  session: { strategy: 'jwt' },
  callbacks: {
    async jwt({ token, user }) { /* ... */ },
    async session({ session, token }) { /* ... */ }
  }
});

export { handler as GET, handler as POST };
```

### Database Schema for Admin Users

Simple admin user table with bcrypt-hashed passwords:
- `email` is unique identifier for login
- `password_hash` stores bcrypt hash (never plain text)
- `role` enables future RBAC (super_admin, admin, viewer)
- `is_active` allows deactivation without deletion

**Seed initial admin:**
```sql
INSERT INTO admin_users (email, password_hash, full_name, role)
VALUES (
  'admin@zyprus.com',
  '$2b$10$...', -- bcrypt hash of password
  'System Administrator',
  'super_admin'
);
```

### Password Hashing with bcrypt

```typescript
import bcrypt from 'bcryptjs';

export async function hashPassword(password: string): Promise<string> {
  const salt = await bcrypt.genSalt(10);
  return bcrypt.hash(password, salt);
}

export async function verifyPassword(password: string, hash: string): Promise<boolean> {
  return bcrypt.compare(password, hash);
}
```

### Admin Dashboard Layout Structure

```
/admin
├── /login (public)
├── layout.tsx (protected, requires auth)
├── page.tsx (Overview)
├── /agents
│   └── page.tsx (Agent Management)
├── /analytics
│   └── page.tsx (Analytics & Reporting)
├── /templates
│   └── page.tsx (Template Management)
├── /calculators
│   └── page.tsx (Calculator Configuration)
├── /logs
│   └── page.tsx (System Logs)
└── /settings
    └── page.tsx (Settings)
```

### Navigation Sidebar

Use Tailwind CSS for responsive sidebar:
- Desktop: Fixed sidebar on left (240px width)
- Tablet: Collapsible sidebar with hamburger menu
- Mobile: Drawer/modal sidebar

**Navigation items:**
1. **Overview** - System dashboard
2. **Agents** - Agent management
3. **Analytics** - Usage analytics
4. **Templates** - Document templates
5. **Calculators** - Calculator configs
6. **Logs** - System logs
7. **Settings** - Admin settings

### Session Verification

Server-side session check in layout:
```typescript
import { getServerSession } from 'next-auth';
import { redirect } from 'next/navigation';

export default async function AdminLayout({ children }) {
  const session = await getServerSession();

  if (!session) {
    redirect('/admin/login');
  }

  return (
    <div>
      <Sidebar />
      <main>{children}</main>
    </div>
  );
}
```

### Environment Variables

```
NEXTAUTH_SECRET=<random_generated_secret>
NEXTAUTH_URL=https://sophia-agent.vercel.app
NEXTAUTH_URL_INTERNAL=http://localhost:3000 (for development)
```

Generate NEXTAUTH_SECRET:
```bash
openssl rand -base64 32
```

### Security Considerations

- Use bcrypt for password hashing (never store plain text)
- Secure session cookies (httpOnly, secure, sameSite)
- CSRF protection (NextAuth.js handles this)
- Rate limiting on login endpoint (prevent brute force)
- Password requirements: min 8 characters, include numbers/symbols
- Session expiration: 24 hours (configurable)

### Accessibility (WCAG AA Compliance)

[Source: PRD - Accessibility Requirements]

Admin dashboard must meet WCAG AA:
- Keyboard navigation for all functions
- Proper heading hierarchy (h1, h2, h3)
- ARIA labels for interactive elements
- Sufficient color contrast (4.5:1 for text)
- Focus indicators for form inputs
- Screen reader support

### Testing Strategy

- Unit tests for password hashing/verification
- Integration tests for NextAuth configuration
- End-to-end tests for login flow
- Manual testing for responsive design
- Accessibility audit with axe DevTools

### Branding

[Source: PRD - Design Principles]

**Color Palette:**
- Primary: Professional blue (#0066CC or similar)
- Secondary: Cyprus-inspired colors
- Neutral: Grays for text and backgrounds
- Success: Green (#22C55E)
- Error: Red (#EF4444)
- Warning: Yellow (#F59E0B)

**Typography:**
- Headings: Bold, clear hierarchy
- Body: Readable sans-serif (Inter, Roboto)
- Code/Data: Monospace (JetBrains Mono)

### Next Story Dependencies

Story 6.6 (System Overview & Monitoring) depends on:
- Admin authentication working
- Admin layout and navigation in place
- Session management functional
- Dashboard home page ready for content
