# Story 6.9: Admin Dashboard - Configuration & Template Management

## Status

Pending

## Story

**As a** frontend developer,
**I want** configuration and template management interface,
**so that** administrators can manage system settings, calculators, and email templates without code changes.

## Acceptance Criteria

1. Settings page with editable system configuration:
   - OpenAI model selection (gpt-4-turbo, gpt-4o, etc.)
   - Response timeout settings
   - Rate limiting thresholds
   - WhatsApp/Telegram webhook URLs
2. Calculator management interface:
   - List all calculators with enabled/disabled status
   - Edit calculator parameters (formulas, descriptions, input fields)
   - Enable/disable calculators
3. Email template management (if Epic 5 complete):
   - List email templates
   - Create/edit/delete templates
   - Preview template rendering
4. Document template management:
   - List document templates (from OpenAI Assistant Knowledge Base)
   - View template metadata (name, description, usage count)
   - Upload new templates (future enhancement, manual for MVP)
5. System logs viewer:
   - Filter logs by level (error, warning, info)
   - Search logs by keyword
   - Export logs as CSV
6. All changes saved to database and take effect immediately
7. Validation and error handling for all configuration changes
8. Responsive layout for desktop and tablet

## Tasks / Subtasks

- [ ] Create database migration for system configuration
  - [ ] Create `packages/database/supabase/migrations/013_create_system_config.sql`
  - [ ] Define `system_config` table schema:
    - `id` UUID PRIMARY KEY DEFAULT gen_random_uuid()
    - `key` TEXT UNIQUE NOT NULL
    - `value` TEXT NOT NULL (store as JSON string)
    - `description` TEXT
    - `updated_by` UUID REFERENCES admin_users(id)
    - `updated_at` TIMESTAMPTZ DEFAULT now()
  - [ ] Seed initial configuration:
    - openai_model: "gpt-4-turbo"
    - response_timeout_ms: 5000
    - rate_limit_per_second: 80
    - whatsapp_webhook_url: "https://..."
    - telegram_webhook_url: "https://..."
  - [ ] Add indexes: `key`
  - [ ] Add RLS policies: admin users can read/update
  - [ ] Apply migration to Supabase database

- [ ] Create API routes for system configuration
  - [ ] Create `/apps/web/src/app/api/admin/config/route.ts`
  - [ ] Implement GET handler to fetch all config keys
  - [ ] Implement PATCH handler to update config:
    - Validate config value format
    - Update config in database
    - Return updated config
  - [ ] Add authentication check (admin only)
  - [ ] Add validation for specific config keys

- [ ] Create API routes for calculator management
  - [ ] Create `/apps/web/src/app/api/admin/calculators/route.ts`
  - [ ] Implement GET handler to list all calculators
  - [ ] Implement POST handler to create new calculator (optional)
  - [ ] Create `/apps/web/src/app/api/admin/calculators/[id]/route.ts`
  - [ ] Implement PATCH handler to update calculator:
    - Edit description, input fields, formula
    - Enable/disable calculator
  - [ ] Add authentication check
  - [ ] Add validation for calculator parameters

- [ ] Create API routes for email templates (if Epic 5 complete)
  - [ ] Create `/apps/web/src/app/api/admin/templates/email/route.ts`
  - [ ] Implement GET handler to list email templates
  - [ ] Implement POST handler to create template
  - [ ] Create `/apps/web/src/app/api/admin/templates/email/[id]/route.ts`
  - [ ] Implement GET handler to fetch template
  - [ ] Implement PATCH handler to update template
  - [ ] Implement DELETE handler to delete template
  - [ ] Add authentication check
  - [ ] Add template rendering preview function

- [ ] Create API route for document templates metadata
  - [ ] Create `/apps/web/src/app/api/admin/templates/documents/route.ts`
  - [ ] Implement GET handler to list document templates:
    - Query document_generations, group by template_filename
    - Count usage per template
    - Return array with template name and usage count
  - [ ] Add authentication check
  - [ ] Note: Actual template files managed in OpenAI Assistant (manual upload)

- [ ] Create API route for system logs
  - [ ] Create `/apps/web/src/app/api/admin/logs/route.ts`
  - [ ] Implement GET handler with filters:
    - Query parameters: level (error/warning/info), search, startDate, endDate, limit
    - Query conversation_logs and other log tables
    - Return paginated log entries
  - [ ] Add authentication check
  - [ ] Add CSV export functionality

- [ ] Create settings page
  - [ ] Create `/apps/web/src/app/admin/settings/page.tsx`
  - [ ] Fetch system config from `/api/admin/config`
  - [ ] Render editable form with config fields:
    - OpenAI model (dropdown: gpt-4-turbo, gpt-4o, gpt-3.5-turbo)
    - Response timeout (number input, milliseconds)
    - Rate limit (number input, messages per second)
    - WhatsApp webhook URL (text input, readonly or editable)
    - Telegram webhook URL (text input, readonly or editable)
  - [ ] Add save button to update config
  - [ ] Show success/error messages on save
  - [ ] Add "Reset to defaults" button
  - [ ] Style with Tailwind CSS

- [ ] Create calculator management page
  - [ ] Create `/apps/web/src/app/admin/calculators/page.tsx`
  - [ ] Fetch calculators from `/api/admin/calculators`
  - [ ] Display calculator list with:
    - Name
    - Description
    - Enabled/Disabled toggle
    - Edit button
  - [ ] Add "Create Calculator" button (optional)
  - [ ] Implement enable/disable toggle (PATCH request)
  - [ ] Add loading and error states

- [ ] Create calculator edit page
  - [ ] Create `/apps/web/src/app/admin/calculators/[id]/edit/page.tsx`
  - [ ] Fetch calculator details from `/api/admin/calculators/[id]`
  - [ ] Render edit form with fields:
    - Name (text input)
    - Description (textarea)
    - Input fields configuration (JSON editor or dynamic form)
    - Formula/calculation logic (code editor or textarea)
    - Is active (checkbox)
  - [ ] Add save button
  - [ ] Add cancel button (return to list)
  - [ ] Validate input before saving
  - [ ] Show success/error messages

- [ ] Create email template management page (if Epic 5 complete)
  - [ ] Create `/apps/web/src/app/admin/templates/email/page.tsx`
  - [ ] Fetch email templates from `/api/admin/templates/email`
  - [ ] Display template list with name, subject, usage count
  - [ ] Add "Create Template" button
  - [ ] Add edit/delete buttons per template
  - [ ] Implement delete with confirmation dialog

- [ ] Create email template editor (if Epic 5 complete)
  - [ ] Create `/apps/web/src/app/admin/templates/email/new/page.tsx`
  - [ ] Create `/apps/web/src/app/admin/templates/email/[id]/edit/page.tsx`
  - [ ] Render form with fields:
    - Template name (text input)
    - Subject line (text input, support variables)
    - Body (rich text editor or textarea, support variables)
    - Variables list (e.g., {{agent_name}}, {{property_address}})
  - [ ] Add preview button to render template with sample data
  - [ ] Add save button
  - [ ] Validate template syntax

- [ ] Create document template viewer page
  - [ ] Create `/apps/web/src/app/admin/templates/documents/page.tsx`
  - [ ] Fetch document template metadata from `/api/admin/templates/documents`
  - [ ] Display template list with:
    - Template filename
    - Usage count (documents generated)
    - Last used date
  - [ ] Add note: "Templates managed via OpenAI Assistant Knowledge Base"
  - [ ] Add link to OpenAI Assistant dashboard (external)

- [ ] Create system logs viewer page
  - [ ] Create `/apps/web/src/app/admin/logs/page.tsx`
  - [ ] Add filter controls:
    - Log level dropdown (All, Error, Warning, Info)
    - Search input (keyword search)
    - Date range selector
  - [ ] Fetch logs from `/api/admin/logs` with filters
  - [ ] Display logs in table:
    - Timestamp
    - Level (badge: red=error, yellow=warning, blue=info)
    - Message
    - Agent (if applicable)
    - Details (expandable)
  - [ ] Add pagination
  - [ ] Add "Export CSV" button
  - [ ] Auto-refresh option (30 seconds)

- [ ] Create configuration utility functions
  - [ ] Create `/apps/web/src/lib/config.ts`
  - [ ] Implement `getConfig(key: string): Promise<any>`
  - [ ] Implement `setConfig(key: string, value: any): Promise<void>`
  - [ ] Implement `validateConfigValue(key: string, value: any): boolean`
  - [ ] Cache config in memory for performance (1-minute TTL)

- [ ] Add JSON editor component for complex config
  - [ ] Install JSON editor: `npm install @monaco-editor/react`
  - [ ] Create `/apps/web/src/components/admin/JsonEditor.tsx`
  - [ ] Use Monaco Editor for syntax highlighting and validation
  - [ ] Props: value, onChange, height
  - [ ] Display validation errors

- [ ] Write tests for API routes
  - [ ] Create `apps/web/src/app/api/admin/config/__tests__/route.test.ts`
  - [ ] Test GET config returns all config keys
  - [ ] Test PATCH config updates value
  - [ ] Test PATCH config validates value format
  - [ ] Create `apps/web/src/app/api/admin/calculators/__tests__/route.test.ts`
  - [ ] Test GET calculators returns list
  - [ ] Test PATCH calculator updates configuration
  - [ ] Create `apps/web/src/app/api/admin/logs/__tests__/route.test.ts`
  - [ ] Test GET logs with filters
  - [ ] Run all tests: `npm test`

- [ ] Write tests for configuration utilities
  - [ ] Create `apps/web/src/lib/__tests__/config.test.ts`
  - [ ] Test getConfig retrieves value
  - [ ] Test setConfig updates value
  - [ ] Test validateConfigValue rejects invalid values
  - [ ] Run all tests: `npm test`

- [ ] Test configuration management end-to-end
  - [ ] Login to admin dashboard
  - [ ] Navigate to Settings page
  - [ ] Change OpenAI model selection
  - [ ] Save changes and verify success message
  - [ ] Verify config persists after page reload
  - [ ] Navigate to Calculators page
  - [ ] Toggle calculator enabled/disabled
  - [ ] Edit calculator description
  - [ ] Save and verify changes
  - [ ] Navigate to Logs page
  - [ ] Filter logs by level
  - [ ] Search logs by keyword
  - [ ] Export logs as CSV
  - [ ] Test on desktop and tablet

## Dev Notes

### System Configuration Management

[Source: PRD Epic 6.9]

**Configuration Keys:**
1. `openai_model` - Which OpenAI model to use (gpt-4-turbo, gpt-4o, gpt-3.5-turbo)
2. `response_timeout_ms` - Maximum time to wait for AI response (milliseconds)
3. `rate_limit_per_second` - Maximum messages per second
4. `whatsapp_webhook_url` - Twilio webhook URL
5. `telegram_webhook_url` - Telegram webhook URL
6. `max_conversation_history` - Number of messages to include in context
7. `auto_archive_days` - Days before archiving old conversations

**Configuration Storage:**
Store as key-value pairs in database table:
```sql
CREATE TABLE system_config (
  id UUID PRIMARY KEY,
  key TEXT UNIQUE NOT NULL,
  value TEXT NOT NULL, -- JSON string
  description TEXT,
  updated_by UUID REFERENCES admin_users(id),
  updated_at TIMESTAMPTZ DEFAULT now()
);
```

### Calculator Management

**Editable Calculator Properties:**
- `name` - Calculator display name
- `description` - What the calculator does
- `input_fields` - Array of input field definitions (JSON)
- `is_active` - Whether calculator is available to agents
- `tool_url` - Reference URL (informational)

**Example input_fields JSON:**
```json
{
  "input_fields": [
    {
      "name": "property_value",
      "label": "Property Value (€)",
      "type": "number",
      "required": true,
      "min": 0
    },
    {
      "name": "is_first_home",
      "label": "First Home?",
      "type": "boolean",
      "required": false,
      "default": false
    }
  ]
}
```

**Note:** Calculator formulas are in code (`packages/services/src/calculator.service.ts`), not editable via UI in MVP. Future enhancement: formula editor with JavaScript evaluation sandbox.

### Email Template Management

[Source: Epic 5 requirements, if implemented]

**Template Structure:**
```typescript
{
  id: UUID,
  name: string, // e.g., "Property Viewing Request"
  subject: string, // e.g., "{{agent_name}} - Property Viewing Request"
  body: string, // HTML or plain text with variables
  variables: string[], // e.g., ["agent_name", "property_address"]
  created_at: Date,
  usage_count: number
}
```

**Variable Substitution:**
```typescript
const renderTemplate = (template: string, variables: Record<string, string>) => {
  return template.replace(/\{\{(\w+)\}\}/g, (match, key) => {
    return variables[key] || match;
  });
};
```

### Document Template Metadata

Document templates are stored in OpenAI Assistant Knowledge Base (uploaded files).
Admin dashboard shows metadata only:
- Template filename
- Usage count (from document_generations table)
- Last used date

Uploading new templates requires:
1. Upload file to OpenAI Assistant via API or dashboard
2. Update Knowledge Base
3. No UI for upload in MVP (manual process)

Future enhancement: File upload UI to add templates directly.

### System Logs Viewer

**Log Sources:**
1. `conversation_logs` - All agent messages
2. Application logs (if using logging service like Sentry)
3. Error logs (caught exceptions)

**Log Filtering:**
```sql
SELECT * FROM logs
WHERE level = $level
AND message ILIKE '%' || $search || '%'
AND created_at >= $startDate AND created_at <= $endDate
ORDER BY created_at DESC
LIMIT $limit OFFSET $offset;
```

**CSV Export:**
```typescript
const exportLogsAsCSV = (logs: Log[]) => {
  const headers = 'Timestamp,Level,Message,Agent,Details';
  const rows = logs.map(log =>
    `${log.created_at},${log.level},"${log.message}",${log.agent_name},"${log.details}"`
  );
  const csv = [headers, ...rows].join('\n');

  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.download = `sophia-logs-${Date.now()}.csv`;
  link.href = url;
  link.click();
};
```

### Configuration Validation

**Validate config values before saving:**
```typescript
const validators = {
  openai_model: (value: string) => ['gpt-4-turbo', 'gpt-4o', 'gpt-3.5-turbo'].includes(value),
  response_timeout_ms: (value: number) => value >= 1000 && value <= 60000,
  rate_limit_per_second: (value: number) => value > 0 && value <= 100,
  whatsapp_webhook_url: (value: string) => /^https?:\/\/.+/.test(value),
  telegram_webhook_url: (value: string) => /^https?:\/\/.+/.test(value)
};

const validateConfig = (key: string, value: any): boolean => {
  const validator = validators[key];
  return validator ? validator(value) : true;
};
```

### Monaco Editor for JSON Editing

For complex config (like calculator input_fields JSON):
```tsx
import Editor from '@monaco-editor/react';

<Editor
  height="300px"
  language="json"
  value={jsonValue}
  onChange={handleChange}
  options={{
    minimap: { enabled: false },
    lineNumbers: 'on',
    formatOnPaste: true,
    formatOnType: true
  }}
/>
```

### Configuration Caching

Cache config in memory to avoid database queries on every request:
```typescript
const configCache = new Map<string, { value: any, timestamp: number }>();
const CACHE_TTL = 60000; // 1 minute

export async function getConfig(key: string): Promise<any> {
  const cached = configCache.get(key);
  if (cached && Date.now() - cached.timestamp < CACHE_TTL) {
    return cached.value;
  }

  const { data } = await supabase
    .from('system_config')
    .select('value')
    .eq('key', key)
    .single();

  const value = JSON.parse(data.value);
  configCache.set(key, { value, timestamp: Date.now() });
  return value;
}
```

Invalidate cache when config updated:
```typescript
export async function setConfig(key: string, value: any): Promise<void> {
  await supabase
    .from('system_config')
    .update({ value: JSON.stringify(value), updated_at: new Date() })
    .eq('key', key);

  configCache.delete(key); // Invalidate cache
}
```

### Security Considerations

- Only admin users can access configuration pages
- Validate all config values server-side
- Log all configuration changes (audit trail)
- Restrict sensitive config (API keys) to read-only or masked display
- Rate limit config update requests

### Testing Strategy

- Unit tests for config validation functions
- Integration tests for config API routes
- End-to-end tests for configuration UI
- Manual testing for calculator management
- Manual testing for template editing

### Future Enhancements (Post-MVP)

- Formula editor for calculators (JavaScript sandbox)
- Template upload UI for document templates
- Role-based access control (super_admin vs admin vs viewer)
- Configuration versioning and rollback
- Template A/B testing
- Scheduled configuration changes
- Configuration import/export (backup/restore)

### Page Layout

**Settings Page:**
- Card for each config section (OpenAI, Rate Limiting, Webhooks)
- Save button per section or global save
- Success/error toasts on save

**Calculators Page:**
- Table with calculator list
- Quick enable/disable toggles
- Edit button per calculator
- "Create Calculator" button (optional)

**Templates Page:**
- Tabs: Email Templates, Document Templates
- List view with create/edit/delete actions
- Preview modal for templates

**Logs Page:**
- Filter bar at top (level, search, date range)
- Table with paginated log entries
- Export button
- Auto-refresh toggle

### Responsive Design

**Desktop (1920px):**
- Full-width forms with inline labels
- Side-by-side config sections
- Wide tables

**Tablet (768px):**
- Stacked config sections
- Narrower forms with stacked labels
- Responsive tables (horizontal scroll)

### Accessibility

- Form labels associated with inputs
- Error messages announced to screen readers
- Keyboard navigation for all controls
- Focus management in modals
- ARIA attributes for dynamic content

### Next Steps After Story Completion

Epic 6 complete! All stories done:
- ✅ Story 6.1: Telegram Bot Setup
- ✅ Story 6.2: Telegram Authentication
- ✅ Story 6.3: Telegram Forwarding
- ✅ Story 6.4: Telegram Conversational Features
- ✅ Story 6.5: Admin Dashboard Authentication
- ✅ Story 6.6: Admin Dashboard Overview
- ✅ Story 6.7: Admin Dashboard Agent Management
- ✅ Story 6.8: Admin Dashboard Analytics
- ✅ Story 6.9: Admin Dashboard Configuration

**After Epic 6:**
1. Run all tests (`npm test`)
2. Deploy to production
3. Test admin dashboard with real data
4. Test Telegram bot end-to-end
5. Update `.claude/epic-progress.json`
6. Document Epic 6 completion in README
7. Prepare for Epic 5 (Email Integration) if credentials available
