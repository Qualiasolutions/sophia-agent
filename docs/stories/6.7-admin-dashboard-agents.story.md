# Story 6.7: Admin Dashboard - Agent Management

## Status

Complete

## Story

**As a** frontend developer,
**I want** agent management interface in admin dashboard,
**so that** administrators can view, create, edit, and deactivate agent accounts.

## Acceptance Criteria

1. Agent list page shows all agents with: name, email, phone, status, registration date
2. Search and filter functionality: by name, email, status (active/inactive)
3. Agent detail view shows: full profile, usage statistics, recent activity, linked Telegram account
4. Create new agent form with validation
5. Edit agent functionality (name, email, phone, status)
6. Deactivate agent: sets `is_active=false`, prevents WhatsApp/Telegram access
7. Pagination for agent list (20 agents per page)
8. Responsive table design for desktop and tablet
9. All CRUD operations tested end-to-end

## Tasks / Subtasks

- [ ] Create API routes for agent management
  - [ ] Create `/apps/web/src/app/api/admin/agents/route.ts`
  - [ ] Implement GET handler for listing agents:
    - Support pagination (page, limit)
    - Support search (name, email)
    - Support filtering (status, source)
    - Return agents array with total count
  - [ ] Implement POST handler for creating agent:
    - Validate required fields (name, email, phone)
    - Check for duplicate email/phone
    - Insert into agents table
    - Return created agent
  - [ ] Add authentication checks
  - [ ] Add input validation and error handling

- [ ] Create API route for single agent operations
  - [ ] Create `/apps/web/src/app/api/admin/agents/[id]/route.ts`
  - [ ] Implement GET handler for agent details:
    - Fetch agent by ID
    - Include usage stats (message count, document count, calculator count)
    - Include recent activity (last 10 conversations)
    - Include linked Telegram account (join telegram_users)
  - [ ] Implement PATCH handler for updating agent:
    - Validate input fields
    - Update agent record
    - Return updated agent
  - [ ] Implement DELETE handler for deactivating agent:
    - Set is_active=false (soft delete)
    - Return success status
  - [ ] Add authentication and authorization checks

- [ ] Create API route for agent statistics
  - [ ] Create `/apps/web/src/app/api/admin/agents/[id]/stats/route.ts`
  - [ ] Implement GET handler for agent statistics:
    - Total messages sent/received
    - Documents generated (count by type)
    - Calculators used (count by type)
    - Last active timestamp
    - Average response time (optional)
  - [ ] Add authentication check
  - [ ] Add caching (1-minute TTL)

- [ ] Create agent list component
  - [ ] Create `/apps/web/src/app/admin/agents/page.tsx`
  - [ ] Fetch agents from `/api/admin/agents`
  - [ ] Display agents in table with columns:
    - Name
    - Email
    - Phone
    - Status (badge: green=active, gray=inactive)
    - Registration Date
    - Actions (View, Edit, Deactivate)
  - [ ] Implement search input (debounced, 300ms delay)
  - [ ] Implement status filter dropdown
  - [ ] Implement pagination controls (prev, next, page numbers)
  - [ ] Add "Create Agent" button
  - [ ] Add loading states and error handling

- [ ] Create agent detail page
  - [ ] Create `/apps/web/src/app/admin/agents/[id]/page.tsx`
  - [ ] Fetch agent details from `/api/admin/agents/[id]`
  - [ ] Display agent profile information
  - [ ] Display usage statistics (cards with numbers)
  - [ ] Display recent activity feed (last 10 items)
  - [ ] Display linked Telegram account (if exists)
  - [ ] Add "Edit" and "Deactivate" buttons
  - [ ] Add loading states and error handling

- [ ] Create agent form component
  - [ ] Create `/apps/web/src/components/admin/AgentForm.tsx`
  - [ ] Props: agent (optional, for edit mode), onSubmit, onCancel
  - [ ] Form fields:
    - Name (required, text input)
    - Email (required, email input with validation)
    - Phone (required, tel input with validation)
    - Status (active/inactive, select dropdown)
  - [ ] Client-side validation:
    - Name: min 2 characters, max 100
    - Email: valid email format
    - Phone: valid phone format (E.164)
  - [ ] Display validation errors
  - [ ] Disable submit during loading
  - [ ] Style with Tailwind CSS

- [ ] Create "Create Agent" page
  - [ ] Create `/apps/web/src/app/admin/agents/new/page.tsx`
  - [ ] Render AgentForm component
  - [ ] On submit, POST to `/api/admin/agents`
  - [ ] On success, redirect to agent list with success message
  - [ ] On error, display error message
  - [ ] Add breadcrumb navigation

- [ ] Create "Edit Agent" page
  - [ ] Create `/apps/web/src/app/admin/agents/[id]/edit/page.tsx`
  - [ ] Fetch agent data from `/api/admin/agents/[id]`
  - [ ] Render AgentForm component with agent data
  - [ ] On submit, PATCH to `/api/admin/agents/[id]`
  - [ ] On success, redirect to agent detail with success message
  - [ ] On error, display error message
  - [ ] Add breadcrumb navigation

- [ ] Implement agent deactivation
  - [ ] Add deactivate button on agent detail page
  - [ ] Show confirmation dialog before deactivation
  - [ ] On confirm, DELETE to `/api/admin/agents/[id]`
  - [ ] On success, redirect to agent list with success message
  - [ ] On error, display error message
  - [ ] Update UI to prevent WhatsApp/Telegram access for deactivated agents

- [ ] Create confirmation dialog component
  - [ ] Create `/apps/web/src/components/admin/ConfirmDialog.tsx`
  - [ ] Props: title, message, onConfirm, onCancel
  - [ ] Render modal overlay with dialog
  - [ ] Style with Tailwind CSS
  - [ ] Add keyboard accessibility (Escape to cancel, Enter to confirm)

- [ ] Add toast notifications
  - [ ] Install toast library: `npm install react-hot-toast`
  - [ ] Create toast utility: `/apps/web/src/lib/toast.ts`
  - [ ] Show success toast on create/update/deactivate
  - [ ] Show error toast on failures
  - [ ] Configure toast position and duration

- [ ] Style agent management pages
  - [ ] Use Tailwind CSS for layout and styling
  - [ ] Create consistent table styles (striped rows, hover effects)
  - [ ] Add responsive design (stack on mobile, table on desktop)
  - [ ] Use icons for actions (edit, delete, view)
  - [ ] Add status badges (colored, rounded)
  - [ ] Ensure accessibility (proper labels, keyboard navigation)

- [ ] Write tests for API routes
  - [ ] Create `apps/web/src/app/api/admin/agents/__tests__/route.test.ts`
  - [ ] Test GET agents returns paginated list
  - [ ] Test GET agents supports search and filtering
  - [ ] Test POST agent creates new agent
  - [ ] Test POST agent validates input
  - [ ] Test POST agent rejects duplicate email
  - [ ] Create `apps/web/src/app/api/admin/agents/[id]/__tests__/route.test.ts`
  - [ ] Test GET agent returns agent details
  - [ ] Test PATCH agent updates agent
  - [ ] Test DELETE agent deactivates agent
  - [ ] Run all tests: `npm test`

- [ ] Write tests for components
  - [ ] Create `apps/web/src/components/admin/__tests__/AgentForm.test.tsx`
  - [ ] Test form renders all fields
  - [ ] Test form validates required fields
  - [ ] Test form submits with valid data
  - [ ] Create `apps/web/src/components/admin/__tests__/ConfirmDialog.test.tsx`
  - [ ] Test dialog renders with title and message
  - [ ] Test dialog calls onConfirm when confirmed
  - [ ] Test dialog calls onCancel when cancelled
  - [ ] Run all tests: `npm test`

- [ ] Test agent management end-to-end
  - [ ] Navigate to /admin/agents
  - [ ] Verify agent list displays correctly
  - [ ] Test search functionality with agent name
  - [ ] Test filter functionality with status
  - [ ] Click "Create Agent" and fill form
  - [ ] Submit form and verify redirect to list
  - [ ] Verify new agent appears in list
  - [ ] Click agent to view details
  - [ ] Verify details page shows correct information
  - [ ] Click "Edit" and modify agent data
  - [ ] Submit edit and verify changes saved
  - [ ] Click "Deactivate" and confirm
  - [ ] Verify agent status changed to inactive
  - [ ] Test pagination with > 20 agents (create test data if needed)
  - [ ] Test responsive design on desktop and tablet

## Dev Notes

### Agent Management Requirements

[Source: PRD Epic 6.7]

**Agent List Features:**
- Display all agents (active and inactive)
- Search by name or email
- Filter by status (active/inactive)
- Sort by registration date, name, last active
- Pagination (20 agents per page)

**Agent CRUD Operations:**
- **Create:** Add new agent with name, email, phone
- **Read:** View agent details, statistics, activity
- **Update:** Edit agent information, status
- **Delete:** Soft delete (set is_active=false)

### Database Queries

**List agents with pagination:**
```sql
SELECT id, name, email, phone, is_active, source, created_at
FROM agents
WHERE name ILIKE '%' || $search || '%' OR email ILIKE '%' || $search || '%'
AND ($status IS NULL OR is_active = $status)
ORDER BY created_at DESC
LIMIT $limit OFFSET $offset;
```

**Agent statistics:**
```sql
-- Message count
SELECT COUNT(*) FROM conversation_logs WHERE agent_id = $agentId;

-- Document count
SELECT COUNT(*) FROM document_generations WHERE agent_id = $agentId;

-- Calculator count
SELECT COUNT(*) FROM calculator_history WHERE agent_id = $agentId;

-- Last active
SELECT MAX(created_at) FROM conversation_logs WHERE agent_id = $agentId;
```

**Linked Telegram account:**
```sql
SELECT telegram_user_id, telegram_username, chat_id, is_active
FROM telegram_users
WHERE agent_id = $agentId;
```

### Agent Form Validation

**Client-side validation (React Hook Form or manual):**
```typescript
const schema = {
  name: {
    required: 'Name is required',
    minLength: { value: 2, message: 'Name must be at least 2 characters' },
    maxLength: { value: 100, message: 'Name must be less than 100 characters' }
  },
  email: {
    required: 'Email is required',
    pattern: { value: /^\S+@\S+$/i, message: 'Invalid email format' }
  },
  phone: {
    required: 'Phone is required',
    pattern: { value: /^\+?[1-9]\d{1,14}$/, message: 'Invalid phone format (E.164)' }
  }
};
```

**Server-side validation:**
- Duplicate email check: `SELECT COUNT(*) FROM agents WHERE email = $email`
- Duplicate phone check: `SELECT COUNT(*) FROM agents WHERE phone = $phone`
- Email format: regex validation
- Phone format: E.164 validation

### Deactivation vs Deletion

**Soft delete (deactivation):**
- Set `is_active=false`
- Agent data retained for audit/analytics
- Can be reactivated later if needed
- Prevents WhatsApp/Telegram access immediately

**Hard delete (not recommended):**
- DELETE FROM agents WHERE id = $id
- Loses all historical data
- May break foreign key constraints
- Only use if GDPR deletion request

### Responsive Table Design

**Desktop (1920px):**
- Full table with all columns
- Fixed column widths
- Horizontal scroll if needed

**Tablet (768px):**
- Reduce to essential columns (name, email, status)
- Hide secondary columns
- Expand to show details on row click

**Mobile (< 768px):**
- Convert to card layout (not table)
- Stack information vertically
- Show key info only

**Tailwind classes:**
```tsx
<table className="min-w-full divide-y divide-gray-200">
  <thead className="bg-gray-50">
    <tr>
      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
        Name
      </th>
      {/* More columns */}
    </tr>
  </thead>
  <tbody className="bg-white divide-y divide-gray-200">
    {agents.map(agent => (
      <tr key={agent.id} className="hover:bg-gray-50">
        <td className="px-6 py-4 whitespace-nowrap">
          {agent.name}
        </td>
        {/* More cells */}
      </tr>
    ))}
  </tbody>
</table>
```

### Pagination Implementation

**Server-side pagination:**
```typescript
const page = parseInt(searchParams.get('page') || '1');
const limit = 20;
const offset = (page - 1) * limit;

// SQL query with LIMIT and OFFSET
const agents = await supabase
  .from('agents')
  .select('*', { count: 'exact' })
  .range(offset, offset + limit - 1);

return {
  agents: agents.data,
  total: agents.count,
  page,
  totalPages: Math.ceil(agents.count / limit)
};
```

**Client-side pagination controls:**
```tsx
<div className="flex justify-between items-center mt-4">
  <button onClick={prevPage} disabled={page === 1}>
    Previous
  </button>
  <span>Page {page} of {totalPages}</span>
  <button onClick={nextPage} disabled={page === totalPages}>
    Next
  </button>
</div>
```

### Toast Notifications

Use react-hot-toast for user feedback:
```typescript
import toast from 'react-hot-toast';

// Success
toast.success('Agent created successfully!');

// Error
toast.error('Failed to create agent. Please try again.');

// Loading
const toastId = toast.loading('Creating agent...');
// ... API call ...
toast.success('Agent created!', { id: toastId });
```

### Confirmation Dialog Pattern

```typescript
const handleDeactivate = async () => {
  const confirmed = await showConfirmDialog({
    title: 'Deactivate Agent',
    message: 'Are you sure you want to deactivate this agent? They will no longer be able to access Sophia via WhatsApp or Telegram.'
  });

  if (confirmed) {
    // Proceed with deactivation
  }
};
```

### Accessibility Considerations

- Table headers with scope="col"
- Row headers with scope="row"
- ARIA labels for icon buttons
- Keyboard navigation (Tab, Enter, Escape)
- Focus management in modals/dialogs
- Screen reader announcements for loading/success/error states

### Testing Strategy

- Unit tests for API routes (CRUD operations)
- Unit tests for form validation
- Integration tests for search and filter
- End-to-end tests for create/edit/deactivate flows
- Manual testing for responsiveness
- Accessibility testing with screen reader

### Future Enhancements (Post-MVP)

- Bulk operations (activate/deactivate multiple agents)
- Export agent list to CSV
- Import agents from CSV
- Advanced filtering (registration date range, last active range)
- Agent activity timeline visualization
- Agent performance metrics dashboard

### Next Story Dependencies

Story 6.8 (Analytics & Reporting) depends on:
- Agent management API routes working
- Data fetching patterns established
- Chart components identified (if using charts)
