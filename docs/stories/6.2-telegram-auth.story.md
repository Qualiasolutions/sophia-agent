# Story 6.2: Telegram User Authentication & Registration

## Status

Pending

## Story

**As a** database architect,
**I want** Telegram users authenticated and associated with agent accounts,
**so that** only authorized agents can use Sophia on Telegram.

## Acceptance Criteria

1. `telegram_users` table created with schema: `id` (UUID), `agent_id` (UUID FK), `telegram_user_id` (bigint, unique), `telegram_username` (text), `chat_id` (bigint), `is_active` (boolean), `registered_at` (timestamp)
2. New Telegram users prompted to register: "Welcome! Please provide your zyprus.com email to link your account."
3. Email validated against `agents` table, matching by email address
4. Once validated, Telegram user linked to agent account
5. Subsequent messages automatically authenticated via Telegram user ID
6. Unregistered users receive registration prompt on every message until registered
7. Registration flow tested end-to-end with test agent account
8. Admin can manually link Telegram users to agents via database (dashboard feature in later story)

## Tasks / Subtasks

- [ ] Create database migration for telegram_users
  - [ ] Create `packages/database/supabase/migrations/010_create_telegram_users.sql`
  - [ ] Define `telegram_users` table schema:
    - `id` UUID PRIMARY KEY DEFAULT gen_random_uuid()
    - `agent_id` UUID NOT NULL REFERENCES agents(id) ON DELETE CASCADE
    - `telegram_user_id` BIGINT UNIQUE NOT NULL
    - `telegram_username` TEXT
    - `telegram_first_name` TEXT
    - `telegram_last_name` TEXT
    - `chat_id` BIGINT NOT NULL
    - `is_active` BOOLEAN DEFAULT true
    - `registered_at` TIMESTAMPTZ DEFAULT now()
    - `last_active_at` TIMESTAMPTZ DEFAULT now()
  - [ ] Add indexes: `telegram_user_id`, `agent_id`, `chat_id`, `is_active`
  - [ ] Add RLS policies: agents can view own Telegram users, service role has full access
  - [ ] Apply migration to Supabase database

- [ ] Create Telegram user types
  - [ ] Update `packages/shared/src/types/telegram.ts`
  - [ ] Define `TelegramUser` database type matching table schema
  - [ ] Define `TelegramRegistrationState` type for multi-turn registration
  - [ ] Export types from `packages/shared/src/types/index.ts`

- [ ] Implement Telegram authentication service
  - [ ] Create `packages/services/src/telegram-auth.service.ts`
  - [ ] Implement `getTelegramUser(telegramUserId: number): Promise<TelegramUser | null>`
  - [ ] Implement `registerTelegramUser(telegramUserId, chatId, agentId, username?, firstName?, lastName?): Promise<TelegramUser>`
  - [ ] Implement `findAgentByEmail(email: string): Promise<Agent | null>`
  - [ ] Implement `deactivateTelegramUser(telegramUserId: number): Promise<void>`
  - [ ] Implement `updateLastActive(telegramUserId: number): Promise<void>`
  - [ ] Export TelegramAuthService from `packages/services/src/index.ts`

- [ ] Implement registration conversation flow
  - [ ] Update `/apps/web/src/app/api/telegram-webhook/route.ts`
  - [ ] On message received, check if user exists via `getTelegramUser()`
  - [ ] If user doesn't exist, start registration flow:
    - Send: "Welcome to Sophia! To get started, please provide your zyprus.com email address to link your account."
    - Store registration state in memory or Redis (simple: check for email pattern in next message)
  - [ ] On next message from unregistered user, validate email format
  - [ ] Look up agent by email using `findAgentByEmail()`
  - [ ] If agent found, call `registerTelegramUser()` to link accounts
  - [ ] Send confirmation: "Account linked successfully! You can now use Sophia on Telegram."
  - [ ] If agent not found, send error: "Email not found. Please contact your administrator."
  - [ ] If user exists and is active, proceed with normal message handling
  - [ ] If user exists but is_active=false, send: "Your account is deactivated. Please contact support."

- [ ] Add registration state management
  - [ ] Create simple in-memory Map for registration states (chat_id -> 'awaiting_email')
  - [ ] Or use existing conversation state mechanism if available
  - [ ] Store state when registration prompt sent
  - [ ] Clear state when registration completes or fails
  - [ ] Add timeout for registration (e.g., 5 minutes)

- [ ] Update conversation logging
  - [ ] Modify conversation_logs insert to include `agent_id` for Telegram messages
  - [ ] Link Telegram messages to registered agent account
  - [ ] Store Telegram user info in metadata field if needed

- [ ] Write tests for authentication service
  - [ ] Create `packages/services/src/__tests__/telegram-auth.service.test.ts`
  - [ ] Test getTelegramUser returns null for new users
  - [ ] Test getTelegramUser returns user for registered users
  - [ ] Test registerTelegramUser creates new user successfully
  - [ ] Test registerTelegramUser fails with duplicate telegram_user_id
  - [ ] Test findAgentByEmail returns agent when email exists
  - [ ] Test findAgentByEmail returns null when email not found
  - [ ] Test deactivateTelegramUser sets is_active=false
  - [ ] Run all tests: `npm test`

- [ ] Write tests for registration flow
  - [ ] Create tests in `apps/web/src/app/api/telegram-webhook/__tests__/route.test.ts`
  - [ ] Test new user receives registration prompt
  - [ ] Test valid email completes registration successfully
  - [ ] Test invalid email returns error message
  - [ ] Test registered user can send messages normally
  - [ ] Test deactivated user receives deactivation message
  - [ ] Run all tests: `npm test`

- [ ] Test end-to-end registration
  - [ ] Send message to bot from new Telegram account
  - [ ] Verify registration prompt received
  - [ ] Send valid zyprus.com agent email
  - [ ] Verify success confirmation received
  - [ ] Verify `telegram_users` table has new entry
  - [ ] Verify subsequent messages work without re-registration
  - [ ] Test with invalid email and verify error handling
  - [ ] Test with duplicate registration attempt

## Dev Notes

### Database Schema Design

[Source: PRD Epic 6.2]

The `telegram_users` table serves as a bridge between Telegram identities and agent accounts:
- `telegram_user_id` is the unique Telegram user identifier (from Telegram API)
- `chat_id` is the Telegram chat ID where bot communicates with user
- `agent_id` foreign key links to existing `agents` table
- `is_active` allows deactivation without deletion (soft delete)

### Registration Flow

Simple two-step registration:
1. User sends first message → Bot prompts for email
2. User sends email → Bot validates and links account

Alternative: Could implement verification code sent to email, but email lookup is simpler for MVP.

### Security Considerations

- Only agents with valid zyprus.com email can register
- Telegram user ID is unique, prevents duplicate registrations
- Email validation prevents unauthorized access
- is_active flag allows admin to revoke access

### Similar Implementation Reference

WhatsApp authentication uses phone number → agent lookup in `agents` table.
Telegram uses email → agent lookup instead, since Telegram doesn't expose phone numbers.

### Email Validation

- Use regex for basic email format validation: `/^[^\s@]+@[^\s@]+\.[^\s@]+$/`
- Check domain is zyprus.com: `email.endsWith('@zyprus.com')`
- Case-insensitive email matching: `LOWER(email)` in database query

### State Management Options

**Option 1: In-memory Map (simplest for MVP)**
```typescript
const registrationStates = new Map<number, 'awaiting_email'>();
```

**Option 2: Redis/Upstash (more robust)**
- Store state in Redis with TTL
- Survives serverless function cold starts
- Better for production at scale

**Option 3: Database table (most persistent)**
- Create `telegram_registration_states` table
- More queries, but fully persistent

**Recommendation:** Start with Option 1 (in-memory), upgrade to Option 2 if needed.

### Error Handling

- Invalid email format: "Invalid email format. Please provide a valid email address."
- Email not found: "No agent account found with that email. Please contact your administrator or verify the email is correct."
- Registration already exists: "Your account is already registered."
- Database errors: "Registration failed. Please try again later."

### Testing Strategy

- Unit tests for TelegramAuthService methods
- Integration tests for registration webhook flow
- Manual testing with real Telegram bot
- Test with multiple concurrent registrations

### Next Story Dependencies

Story 6.3 (Message Forwarding) depends on:
- Telegram users being authenticated
- Agent association established
- Conversation logging working correctly
